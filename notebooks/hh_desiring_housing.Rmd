---
title: "Households desiring housing"
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = T, message = F, warning = F, echo = F)
```

```{r lib}
library(ipumsr)
library(tidyverse)
library(srvyr)
library(tidycensus)
library(hrbrthemes)
library(camiller)
library(scales)
library(kableExtra)
```

```{r gg etc}
theme_set(theme_ipsum_rc())

#this theme is better when reverse is standard so poor != red, but also this theme sucks by default because it's based on mineral water, but here we are.
pal <- pal <- rev(LaCroixColoR::lacroix_palette(name = "Pamplemousse", n = 5, type = "discrete"))

scale_fill_custom <- function(palette = pal, rev = F) {
  if (rev) {
    scale_fill_manual(values = rev(pal))
  } else {
    scale_fill_manual(values = pal)
  }
}

scale_color_custom <- function(palette = pal, rev = F) {
  if (rev) {
    scale_color_manual(values = rev(pal))
  } else {
    scale_color_manual(values = pal)
  }
}
```

This notebook needs a better name. "Households desiring housing" to me suggests a household wants to move, not that they're unable to afford housing. Maybe just "gaps in housing units available to households by income band" or something? Kind of a mouthful...

There's a lot going on in this notebook:

* Count and share of households by income band by area
    * **Divisions of county median income make the most sense because HUD regions (HMFAs) cross PUMA and county lines, but consult with Urban here.**
    * Rounded to pretty numbers for legibility?
* The kinds of occupations/jobs those residents work in
    * Not super germane to the conversation unless we're talking about wage reform, but brings the context back down to earth...
* Count and share of households in each band that are cost-burdened (T2 in DC report)
* The approximate monthly housing cost for an affordable unit for each income band.
    * Rounded to pretty numbers for legibility?
* Count and share of units by those cost bands in the area (T3 in DC report).
* Number of housing units needed for each cost band so each household would have an affordable housing cost, vs. the actual count of units in those cost bands (F19 in DC report)
* For each income band, the number of households that can/cannot afford to pay more, and a count of vacant units in that cost band (F20 in DC report).


## Set survey design

Starting by using county median incomes (CMI), then income bands like we did in the Community Index reports...

* poor: < 0.5 CMI
* low-income: [0.5–0.75) CMI
* middle-income: [0.75–1.25) CMI
* high-income: [1.25–1.50) CMI
* affluent: >= 1.5 CMI

Cost-burden in predictable breaks:

* No burden: Less than 30% income to housing
* Cost-burdened: 30%-50% income to housing
* Severely cost-burdened: More than 50% income to housing

And race/ethnicty into a few major categories so we can look at it by county:

* White (NH)
* Black (NH)
* Latino (any race)
* All others (grouped)

```{r data prep}
minc <- get_acs(
  	geography = "county",
	  table = "B19013",
  	state = 09,
	  cache_table = T) %>% 
	arrange(GEOID) %>% 
	mutate(countyfip = seq(from = 1, to = 15, by = 2),
				 name = str_remove(NAME, ", Connecticut")) %>% 
	select(countyfip, name, minc = estimate)

ddi <- read_ipums_ddi("../input_data/usa_00037.xml")

pums <- read_ipums_micro(ddi, verbose = F)  %>% 
	mutate_at(vars(YEAR, PUMA, OWNERSHP, OWNERSHPD, RACE, RACED, HISPAN, HISPAND), as_factor) %>% 
	mutate_at(vars(PERWT, HHWT), as.numeric) %>% 
	mutate_at(vars(HHINCOME, OWNCOST, RENTGRS), as.integer) %>% 
	janitor::clean_names() %>% 
	left_join(minc, by = "countyfip") %>% 
	mutate(ratio = hhincome / minc) %>% 
	mutate(
		inc_band = cut(
			ratio,
			breaks = c(-Inf, 0.5, 0.75, 1.25, 1.5, Inf),
			labels = c("Poor", "Low", "Middle", "High", "Affluent"),
			include.lowest = T, right = F)) %>% 
	mutate(
		inc_band = as.factor(inc_band) %>%
			fct_relevel(., "Poor", "Low", "Middle", "High", "Affluent")) %>% 
	mutate(cb = if_else(ownershp == "Rented", (rentgrs * 12) / hhincome, 99999)) %>% 
	mutate(cb = if_else(ownershp == "Owned or being bought (loan)", (owncost * 12) / hhincome, cb)) %>%
	# if rent is 0 and income is 0, no burden
	mutate(cb = if_else((rentgrs == 0 & hhincome == 0), 0, cb)) %>% 
	#if income is 0 and rent is >0, burden
	mutate(
		cost_burden = cut(
			cb,
			breaks = c(-Inf, .3, .5, Inf),
			labels = c("No burden", "Cost-burdened", "Severely cost-burdened"),
			include.lowest = T, right = F)) %>% 
		mutate(race2 = if_else(hispan == "Not Hispanic", as.character(race), "Latino")) %>% 
	mutate(race2 = as.factor(race2) %>% 
				 	fct_recode(Black = "Black/African American/Negro") %>%
				 	fct_other(keep = c("White", "Black", "Latino"), other_level = "Other race") %>%
				 	fct_relevel("White", "Black", "Latino", "Other race"))

des <- pums %>%
	filter(pernum == "1", hhincome != 9999999, ownershp != "N/A") %>% 
	as_survey_design(., ids = 1, wt = hhwt)

out <- list()
```

## Household counts/shares by income bands

```{r hh by inc band}
county_hhlds <- des %>%
	select(hhwt, name, inc_band) %>% 
	group_by(name, inc_band) %>% 
	summarise(value = survey_total(hhwt)) %>% 
	mutate(level = "2_counties")

county_total <- des %>%
	select(hhwt, name) %>% 
	group_by(name) %>% 
	summarise(value = survey_total(hhwt)) %>% 
	mutate(inc_band = "Total") %>% 
	mutate(level = "2_counties")

ct_hhlds <- des %>%
	select(hhwt, statefip, inc_band) %>% 
	group_by(statefip, inc_band) %>% 
	summarise(value = survey_total(hhwt)) %>% 
	mutate(name = "Connecticut", level = "1_state") %>% 
	select(-statefip)

ct_total <- des %>%
	select(hhwt, statefip) %>% 
	group_by(statefip) %>% 
	summarise(value = survey_total(hhwt)) %>% 
	mutate(name = "Connecticut", level = "1_state", inc_band = "Total") %>% 
	select(-statefip)

hh_by_inc_band <- bind_rows(county_hhlds, county_total, ct_hhlds, ct_total) %>%
	ungroup() %>%
	mutate(inc_band = as.factor(inc_band) %>% 
				 	fct_relevel(., "Poor", "Low", "Middle", "High", "Affluent", "Total"),
				 level = as.factor(level)) %>% 
	arrange(level, name) %>% 
	group_by(level, name) %>% 
	calc_shares(group = inc_band, denom = "Total", value = value, moe = value_se)

out$hh_by_inc_band <- hh_by_inc_band
```

### Define income bands

Would it be preferable to set these as prettier breaks, or use the CT numbers for all counties?

```{r inc table}
ctminc <- get_acs(geography = "state", state = 09, table = "B19013") %>% 
	select(name = NAME, minc = estimate)

income_table <- minc %>% 
	bind_rows(ctminc) %>% 
	mutate(p = comma(round(minc * .5, 0), accuracy = 1),
				 l = comma(round(minc * .75, 0), accuracy = 1),
				 m = comma(round(minc * 1.25, 0), accuracy = 1), 
				 h = comma(round(minc * 1.5, 0), accuracy = 1),
				 Poor = paste("Less than $", p, sep = ""),
				 Low = paste("Between $", p, " and $", l, sep = ""),
				 Middle = paste("Between $", l, " and $", m, sep = ""),
				 High = paste("Between $", m, " and $", h, sep = ""),
				 Affluent = paste("More than $", h, sep = "")) %>% 
	select(Name = name, Poor:Affluent)

kable(income_table, caption = "Income ranges by income band and area")
```

### Race breakdowns

```{r}
county_hhlds_by_race <- des %>%
	select(hhwt, name, inc_band, race2) %>% 
	group_by(name, inc_band, race2) %>% 
	summarise(value = survey_total(hhwt)) %>% 
	mutate(level = "2_counties")

county_race_total <- des %>%
	select(hhwt, name, race2) %>% 
	group_by(name, race2) %>% 
	summarise(value = survey_total(hhwt)) %>% 
	mutate(inc_band = "total") %>% 
	mutate(level = "2_counties")

ct_hhlds_by_race <- des %>%
	select(hhwt, statefip, inc_band, race2) %>% 
	group_by(statefip, inc_band, race2) %>% 
	summarise(value = survey_total(hhwt)) %>% 
	mutate(name = "Connecticut", level = "1_state") %>% 
	select(-statefip)

ct_race_total <- des %>%
	select(hhwt, statefip, race2) %>% 
	group_by(statefip, race2) %>% 
	summarise(value = survey_total(hhwt)) %>% 
	mutate(name = "Connecticut", level = "1_state", inc_band = "Total") %>% 
	select(-statefip)

hh_by_race_inc_band <- bind_rows(county_hhlds_by_race, county_race_total, ct_hhlds_by_race, ct_race_total) %>%
	ungroup() %>%
	mutate(inc_band = as.factor(inc_band) %>% 
				 	fct_relevel(., "Poor", "Low", "Middle", "High", "Affluent", "Total"),
				 level = as.factor(level)) %>% 
	arrange(level, name, race2) %>% 
	group_by(level, name, race2) %>% 
	calc_shares(group = inc_band, denom = "Total", value = value, moe = value_se)

out$hh_by_inc_band <- hh_by_race_inc_band
```

Considering race/ethnicity of head of household. More than half of all households headed by a Black or Latino person are poor or low income, compared to about a third of households headed by a white person. Only showing CT here, but there's some variation by county, with more equitable distributions in Litchfield and Windham, less in Fairfield, New Haven, and Hartford.

```{r}
hh_by_race_inc_band %>% 
	filter(name == "Connecticut", inc_band != "Total") %>% 
	mutate(race2 = fct_rev(race2)) %>% 
	ggplot(aes(share, race2, group = race2)) +
	geom_col(aes(fill = inc_band), width = .8, position = position_stack(1)) +
	guides(fill = guide_legend(title = "", reverse = T)) +
	geom_text(aes(label = percent(share, accuracy = 1)),
						position = position_stack(.5), family = "Roboto Condensed") +
	scale_x_continuous(expand = expansion(mult = c(0, 0))) +
	guides(fill = guide_legend(title = "")) +
	scale_fill_custom() +
	labs(x = "", y = "",
			 title = "Share of households in each income band by race of HOH",
			 subtitle = "Connecticut") +
	theme(panel.grid.major  = element_blank(),
				panel.grid.minor = element_blank(),
				axis.text.y = element_text(colour = "black"),
				axis.text.x = element_blank(),
				legend.position = "bottom",
				plot.title.position = "plot")
```

### Count/share of households by income band

More than half a million households in CT (40% of all households) are poor or low-income, earning less than three-quarters of their county's median income. A similar share are affluent or high income, earning  125% or more of their county's median income. Just one in five households statewide are considered middle income by this definition.

```{r}
hh_by_inc_band %>% 
	filter(inc_band != "Total", name == "Connecticut") %>% 
	mutate(inc_band = fct_rev(inc_band)) %>% 
	ggplot(aes(value, inc_band)) +
	geom_col(aes(fill = inc_band), width = .7, position = position_dodge(.8)) +
	scale_x_continuous(
		expand = expansion(mult = c(0, 0.1)),
		labels = scales::comma) +
	geom_text(aes(
		label = comma(value, accuracy = 1)),
		position = position_dodge(.8), hjust = 1, family = "Roboto Condensed", size = 3.75) +
	guides(fill = guide_legend(title = "")) +
	labs(
		x = "",
		y = "",
		title = "Number of households in each income band",
		subtitle = "Connecticut") +
	scale_fill_custom() +
	theme(
		panel.grid.minor = element_blank(),
		panel.grid.major = element_blank(),
		legend.position = "none",
		plot.title.position = "plot",
		axis.text.x = element_blank(),
		axis.text.y = element_text(colour = "black"),
		strip.text.y = element_blank())
```

```{r}
knitr::kable(hh_by_inc_band %>% 
	mutate(level = fct_rev(level)) %>% 
	arrange(level) %>% 
	select(Name = name, inc_band, value) %>% 
	mutate(value = comma(value, accuracy = 1)) %>% 
	pivot_wider(id_cols = Name, names_from = "inc_band") %>% 
	select(Name, Poor:Affluent, Total))
```


The income distributions are fairly consistent, even in the more rural counties. This trend mirrors national trends with middle income households being squeezed out by high and low income households.

```{r fig.width=8, fig.height=8}
hh_by_inc_band %>% 
	filter(inc_band != "Total") %>% 
	group_by(level) %>% 
	mutate(name = as.factor(name) %>% 
				 	fct_rev()) %>% 
	ggplot(aes(name, share, group = name)) +
	geom_col(aes(fill = inc_band), width = .7, position = position_stack(1)) +
	coord_flip() +
	geom_text(aes(label = percent(share, accuracy = 1)),
						position = position_stack(.5), family = "Roboto Condensed") +
	scale_y_continuous(expand = expansion(mult = c(0, 0))) +
	scale_fill_custom() +
	guides(fill = guide_legend(title = "")) +
	labs(x = "", y = "",
			 title = "Share of households in each income band by state and county") +
	theme(panel.grid.major  = element_blank(),
				panel.grid.minor = element_blank(),
				axis.text.y = element_text(colour = "black"),
				axis.text.x = element_blank(),
				legend.position = "bottom",
				plot.title.position = "plot")
```

**Out of curiosity, I also want to see the share of a county's units in each income band (so like what share of all affluent households are in FC) Will come back to that later.**

## Cost burden by income band

```{r}
county_cb <- des %>%
	select(hhwt, name, inc_band, cost_burden) %>% 
	group_by(name, inc_band, cost_burden) %>% 
	summarise(value = survey_total(hhwt)) %>% 
	mutate(level = "2_counties")

ct_cb <- des %>%
	select(hhwt, statefip, inc_band, cost_burden) %>%
	group_by(statefip, inc_band, cost_burden) %>%
	summarise(value = survey_total(hhwt)) %>%
	mutate(name = "Connecticut", level = "1_state") %>%
	select(-statefip)

cb_by_inc_band <- bind_rows(county_cb, county_hhlds, ct_cb, ct_hhlds) %>%
	mutate(cost_burden = if_else(is.na(cost_burden), "Total", as.character(cost_burden)),
				 cost_burden = as.factor(cost_burden) %>% 
				 	fct_relevel(., "No burden", "Cost-burdened", "Severely cost-burdened", "Total")) %>% 
	ungroup() %>%
	mutate(inc_band = as.factor(inc_band) %>%
				 	fct_relevel(., "Poor", "Low", "Middle", "High", "Affluent"),
				 level = as.factor(level)) %>%
	arrange(level, name, inc_band) %>%
	group_by(level, name, inc_band) %>%
	calc_shares(group = cost_burden, denom = "Total", value = value, moe = value_se)

out$cb_by_inc_band <- cb_by_inc_band
```

No surprise that cost burden rates among poor households are around 80%, at the statewide level that's 20x the rate of affluent households.

What does stand out a bit are the gaps between each group. Moving up the income scale (from lower to higher income) shows a 20-30 percentage point decrease in cost burden rates. Those gains are much smaller from medium to high and from high to affluent income groups. Not like anyone was doubting this before, but this chart essentially says there's not enough housing is affordable to low-income households, but there's plenty of housing affordable to mid-to-high income households.

Too bad I can't do this by town...

```{r fig.width=8}
cb_by_inc_band %>% 
	mutate(cost_burden = fct_collapse(cost_burden, Burden = c("Cost-burdened", "Severely cost-burdened"))) %>% 
	ungroup() %>% 
	select(-share, -sharemoe, -value_se) %>% 
	group_by(level, name, inc_band, cost_burden) %>% 
	summarise(value = sum(value)) %>% 
	ungroup() %>% 
	group_by(level, name, inc_band) %>% 
	calc_shares(group = cost_burden, denom = "Total", value = value) %>% 
	filter(cost_burden == "Burden") %>% 
	group_by(level) %>% 
	mutate(name = as.factor(name) %>% 
				 	fct_rev()) %>% 
	ggplot(aes(share, name, group = inc_band)) +
	geom_point(aes(color = inc_band), size = 7.5, alpha = .8) +
	geom_text(aes(
		label = percent(share, accuracy = 1)),
		family = "Roboto Condensed", size = 3.55) +
	scale_x_continuous(expand = expansion(mult = c(.025, .1))) +
	guides(color = guide_legend(title = "")) +
	labs(
		x = "",
		y = "",
		title = "Cost-burden rates for households in each income band",
		subtitle = "County and state") +
	scale_color_custom() +
	theme(
		panel.grid.minor = element_blank(),
		panel.grid.major.x = element_blank(),
		legend.position = "bottom",
		plot.title.position = "plot",
		axis.text.x = element_blank(),
		axis.text.y = element_text(colour = "black"))
```

For all households but the poorest, twice the share of households pay between 30% and 50% of income towards housing than pay more than 50%. Among the poor, the inverse is true. This is partially explained by some poor households having housing costs but no or negative income (by definition, the household is "poor" if household income is $0 or less because that's less than 50% CMI), but obvs there's also just a paucity of affordable housing.

**See how many SCB households have no or negative income to make that point.**

```{r fig.height=8, fig.width=8}
cb_by_inc_band %>% 
	ungroup() %>% 
	filter(!cost_burden %in% c("Total", "No burden")) %>% 
	group_by(level) %>% 
	mutate(name = as.factor(name) %>% 
				 	fct_rev()) %>% 
	ggplot(aes(share, name, group = inc_band)) +
	geom_point(aes(color = inc_band), size = 6.5, alpha = 0.8) +
	geom_text(aes(
		label = percent(share, accuracy = 1)),
		family = "Roboto Condensed", size = 2.75, alpha = 0.8) +
	scale_x_continuous(expand = expansion(mult = c(.025, .1))) +
	facet_grid(rows = "cost_burden", scales = "free", space = "fixed") +
	guides(color = guide_legend(title = "")) +
	labs(
		x = "",
		y = "",
		title = "Rates of burden by burden type for households in each income band",
		subtitle = "County and state",
		caption = "Cost-burdened: spending 30%-50% of household income on housing;\nSeverely cost-burdened: spending more than 50% of household income on housing.") +
	scale_color_custom() +
	theme(
		panel.grid.minor = element_blank(),
		panel.grid.major.x = element_blank(),
		legend.position = "bottom",
		plot.title.position = "plot",
		axis.text.x = element_blank(),
		axis.text.y = element_text(colour = "black"))
```

## Jobs held by people in these households

Woops need to add OCC to PUMS output, then I guess do like top 3-5 most common jobs for each income band (limit to HOHs?)

```{r}

```

## Housing costs affordable to household within each band

Over-under on the actual number of units costing less than $1.2K in FC? I'll say 10,000.

```{r}
affordable_cost_table <- minc %>% 
	bind_rows(ctminc) %>% 
	select(-countyfip) %>% 
	mutate(p = minc * .5,
				 l = minc * .75,
				 m = minc * 1.25, 
				 h = minc * 1.5) %>% 
	select(-minc) %>% 
	pivot_longer(cols = p:h, names_to = "inc_band", values_to = "income") %>% 
	mutate(income = round(income, 0),
				 affordable_hcost = round(income / 12 * .3, 0)) %>% 
	select(name, inc_band, affordable_hcost) %>% 
	mutate(affordable_hcost = comma(affordable_hcost, accuracy = 1)) %>% 
	pivot_wider(id_cols = name, names_from = inc_band, values_from = affordable_hcost) %>% 
	mutate(Poor = paste("Less than $", p, sep = ""),
				 Low = paste("Between $", p, " and $", l, sep = ""),
				 Middle = paste("Between $", l, " and $", m, sep = ""),
				 High = paste("Between $", m, " and $", h, sep = ""),
				 Affluent = paste("More than $", h, sep = ""))

kable(affordable_cost_table %>% 
				select(Name = name, Poor:Affluent),
			caption = "Affordable monthly housing cost ranges by income band and area")
```