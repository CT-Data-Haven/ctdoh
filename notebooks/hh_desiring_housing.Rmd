---
title: "Households desiring housing"
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = T, message = F, warning = F, echo = F)
```

```{r lib}
library(ipumsr)
library(tidyverse)
library(srvyr)
library(tidycensus)
library(hrbrthemes)
library(camiller)
library(scales)
library(kableExtra)
```

```{r gg etc}
theme_set(theme_ipsum_rc())

#this theme is better when reverse is standard so poor != red, but also this theme is also terrible by default because it's based on mineral water, but i am a monster.
pal <- pal <- rev(LaCroixColoR::lacroix_palette(name = "Pamplemousse", n = 5, type = "discrete"))

scale_fill_custom <- function(palette = pal, rev = F) {
  if (rev) {
    scale_fill_manual(values = rev(pal))
  } else {
    scale_fill_manual(values = pal)
  }
}

scale_color_custom <- function(palette = pal, rev = F) {
  if (rev) {
    scale_color_manual(values = rev(pal))
  } else {
    scale_color_manual(values = pal)
  }
}
```

This notebook needs a better name. "Households desiring housing" to me suggests a household wants to move, not that they're unable to afford housing. Maybe just "gaps in housing units available to households by income band" or something? Kind of a mouthful...

There's a lot going on in this notebook:

* Count and share of households by income band by area
    * Rounded to pretty numbers for legibility?
* The kinds of occupations/jobs those residents work in
    * Not exactly germane to the conversation unless we're talking about wage reform, but brings the context back down to earth...
* Count and share of households in each band that are cost-burdened (T2 in DC report)
* Average (median?) housing-cost-to-income ratio for each income band
* The approximate monthly housing cost for an affordable unit (30%) for each income band.
    * Rounded to pretty numbers for legibility?
* Count and share of units by those cost bands in the area (T3 in DC report).
* Number of housing units needed for each cost band so each household would have an affordable housing cost, vs. the actual count of units in those cost bands (F19 in DC report)
* For each income band, the number of households that can/cannot afford to pay more
* Count of vacant units in each cost band (F20 in DC report).


## Establish groups

After discussion with team on 7/15 we are settled with using median hh income by county and the groupings below:

* very low income: <= 0.3 CMI
* low income: (0.3–0.5] CMI
* mid-low income: (0.5–.8] CMI
* mid-high income: (.8–1.2] CMI
* high income: > 1.2 CMI

Cost-burden in predictable breaks:

* No burden: Less than 30% income to housing
* Cost-burdened: 30%-50% income to housing
* Severely cost-burdened: More than 50% income to housing

And race/ethnicity into a few major categories so we can look at it by county:

* White (NH)
* Black (NH)
* Latino (any race)
* All others (grouped)

And for everyone we're considering affordable 30%, not the sliding scale they used in the DC report.

```{r data prep}
minc <- get_acs(
  	geography = "county",
	  table = "B19013",
  	state = 09,
	  cache_table = T) %>% 
	arrange(GEOID) %>% 
	mutate(countyfip = seq(from = 1, to = 15, by = 2),
				 name = str_remove(NAME, ", Connecticut")) %>% 
	select(countyfip, name, minc = estimate)

ddi <- read_ipums_ddi("../input_data/usa_00038.xml")

pums <- read_ipums_micro(ddi, verbose = F)  %>% 
	mutate_at(vars(YEAR, PUMA, OWNERSHP, OWNERSHPD, RACE, RACED, HISPAN, HISPAND), as_factor) %>% 
	mutate_at(vars(PERWT, HHWT), as.numeric) %>% 
	mutate_at(vars(HHINCOME, OWNCOST, RENTGRS, OCC), as.integer) %>% 
	janitor::clean_names() %>% 
	left_join(minc, by = "countyfip") %>% 
	mutate(ratio = hhincome / minc) %>% 
	mutate(
		inc_band = cut(
			ratio,
			breaks = c(-Inf, 0.3, 0.5, .8, 1.2, Inf),
			labels = c("Very low", "Low", "Mid-low", "Mid-high", "High"),
			include.lowest = T, right = T)) %>% 
	mutate(
		inc_band = as.factor(inc_band) %>%
			fct_relevel(., "Very low", "Low", "Mid-low", "Mid-high", "High")) %>% 
	mutate(cb = if_else(ownershp == "Rented", (rentgrs * 12) / hhincome, 99999)) %>% 
	mutate(cb = if_else(ownershp == "Owned or being bought (loan)", (owncost * 12) / hhincome, cb)) %>%
	# if housing cost is 0 and income is 0, no burden
	mutate(cb = if_else((rentgrs == 0 & hhincome == 0), 0, cb)) %>%
	mutate(cb = if_else((owncost == 0 & hhincome == 0), 0, cb)) %>%
	#if income is <=0 and housing cost is >0, burden
	mutate(cb = if_else((rentgrs > 0 & hhincome <= 0), 1, cb)) %>%
	mutate(cb = if_else((owncost > 0 & hhincome <= 0), 1, cb)) %>%
	# some people pay more than 100% income to housing, but I will code these as 1
	mutate(cb = if_else(cb > 1, 1, cb)) %>%
	mutate(
		cost_burden = cut(
			cb,
			breaks = c(-Inf, .3, .5, Inf),
			labels = c("No burden", "Cost-burdened", "Severely cost-burdened"),
			include.lowest = T, right = F)) %>% 
		mutate(race2 = if_else(hispan == "Not Hispanic", as.character(race), "Latino")) %>% 
	mutate(race2 = as.factor(race2) %>% 
				 	fct_recode(Black = "Black/African American/Negro") %>%
				 	fct_other(keep = c("White", "Black", "Latino"), other_level = "Other race") %>%
				 	fct_relevel("White", "Black", "Latino", "Other race"))

des <- pums %>%
	filter(pernum == "1", hhincome != 9999999, ownershp != "N/A") %>% 
	as_survey_design(., ids = 1, wt = hhwt)

out <- list()
```

```{r hh by inc band}
county_hhlds <- des %>%
	select(hhwt, name, inc_band) %>% 
	group_by(name, inc_band) %>% 
	summarise(value = survey_total(hhwt)) %>% 
	mutate(level = "2_counties")

county_total <- des %>%
	select(hhwt, name) %>% 
	group_by(name) %>% 
	summarise(value = survey_total(hhwt)) %>% 
	mutate(inc_band = "Total") %>% 
	mutate(level = "2_counties")

ct_hhlds <- des %>%
	select(hhwt, statefip, inc_band) %>% 
	group_by(statefip, inc_band) %>% 
	summarise(value = survey_total(hhwt)) %>% 
	mutate(name = "Connecticut", level = "1_state") %>% 
	select(-statefip)

ct_total <- des %>%
	select(hhwt, statefip) %>% 
	group_by(statefip) %>% 
	summarise(value = survey_total(hhwt)) %>% 
	mutate(name = "Connecticut", level = "1_state", inc_band = "Total") %>% 
	select(-statefip)

hh_by_inc_band <- bind_rows(county_hhlds, county_total, ct_hhlds, ct_total) %>%
	ungroup() %>%
	mutate(inc_band = as.factor(inc_band) %>% 
				 	fct_relevel(., "Very low", "Low", "Mid-low", "Mid-high", "High", "Total"),
				 level = as.factor(level)) %>% 
	arrange(level, name) %>% 
	group_by(level, name) %>% 
	calc_shares(group = inc_band, denom = "Total", value = value, moe = value_se)

out$hh_by_inc_band <- hh_by_inc_band
```

## Define income bands

Would it be preferable to set these as prettier breaks, or use the CT numbers for all counties?

**A better chart here would be color coded segments indicating each group's range, with each area on a new row. Could use arrow ends or something to communicate the top and bottom. Come back to this idea.**

```{r inc table}
ctminc <- get_acs(geography = "state", state = 09, table = "B19013") %>% 
	select(name = NAME, minc = estimate)

income_table <- minc %>% 
	bind_rows(ctminc) %>% 
	mutate(vl = comma(round(minc * .5, 0), accuracy = 1),
				 l = comma(round(minc * .75, 0), accuracy = 1),
				 ml = comma(round(minc * 1.25, 0), accuracy = 1), 
				 mh = comma(round(minc * 1.5, 0), accuracy = 1),
				 `Very low` = paste("Less than $", vl, sep = ""),
				 Low = paste("Between $", vl, " and $", l, sep = ""),
				 `Mid-low` = paste("Between $", l, " and $", ml, sep = ""),
				 `Mid-high` = paste("Between $", ml, " and $", mh, sep = ""),
				 High = paste("More than $", mh, sep = "")) %>% 
	select(Name = name, `Very low`:High)

kable(income_table, caption = "Income ranges by income band and area")
```

## Count/share of households by income band

Using the new breakdowns, high income households *vastly* outnumber lower income households.

```{r}
hh_by_inc_band %>% 
	filter(inc_band != "Total", name == "Connecticut") %>% 
	mutate(inc_band = fct_rev(inc_band)) %>% 
	ggplot(aes(value, inc_band)) +
	geom_col(aes(fill = inc_band), width = .7, position = position_dodge(.8)) +
	scale_x_continuous(
		expand = expansion(mult = c(0, 0.1)),
		labels = scales::comma) +
	geom_text(aes(
		label = comma(value, accuracy = 1)),
		position = position_dodge(.8), hjust = 1, family = "Roboto Condensed", size = 3.75) +
	guides(fill = guide_legend(title = "")) +
	labs(
		x = "",
		y = "",
		title = "Number of households in each income band",
		subtitle = "Connecticut") +
	scale_fill_custom(rev = T) +
	theme(
		panel.grid.minor = element_blank(),
		panel.grid.major = element_blank(),
		legend.position = "none",
		plot.title.position = "plot",
		axis.text.x = element_blank(),
		axis.text.y = element_text(colour = "black"),
		strip.text.y = element_blank())
```

```{r}
kable(hh_by_inc_band %>% 
	mutate(level = fct_rev(level)) %>% 
	arrange(level) %>% 
	select(Name = name, inc_band, value) %>% 
	mutate(value = comma(value, accuracy = 1)) %>% 
	pivot_wider(id_cols = Name, names_from = "inc_band") %>% 
	select(Name, `Very low`:High, Total),
	caption = "Number of households by income band")
```

The income distributions are fairly consistent.

```{r fig.width=8, fig.height=8}
hh_by_inc_band %>% 
	filter(inc_band != "Total") %>% 
	group_by(level) %>% 
	mutate(name = as.factor(name) %>% 
				 	fct_rev()) %>% 
	ggplot(aes(name, share, group = name)) +
	geom_col(aes(fill = inc_band), width = .7, position = position_stack(1)) +
	coord_flip() +
	geom_text(aes(label = percent(share, accuracy = 1)),
						position = position_stack(.5), family = "Roboto Condensed") +
	scale_y_continuous(expand = expansion(mult = c(0, 0))) +
	scale_fill_custom() +
	guides(fill = guide_legend(title = "")) +
	labs(x = "", y = "",
			 title = "Share of households in each income band by state and county") +
	theme(panel.grid.major  = element_blank(),
				panel.grid.minor = element_blank(),
				axis.text.y = element_text(colour = "black"),
				axis.text.x = element_blank(),
				legend.position = "bottom",
				plot.title.position = "plot")
```

## Household characteristics by income bands

### Race breakdowns

```{r}
county_hhlds_by_race <- des %>%
	select(hhwt, name, inc_band, race2) %>% 
	group_by(name, inc_band, race2) %>% 
	summarise(value = survey_total(hhwt)) %>% 
	mutate(level = "2_counties")

county_race_total <- des %>%
	select(hhwt, name, race2) %>% 
	group_by(name, race2) %>% 
	summarise(value = survey_total(hhwt)) %>% 
	mutate(inc_band = "Total") %>% 
	mutate(level = "2_counties")

ct_hhlds_by_race <- des %>%
	select(hhwt, statefip, inc_band, race2) %>% 
	group_by(statefip, inc_band, race2) %>% 
	summarise(value = survey_total(hhwt)) %>% 
	mutate(name = "Connecticut", level = "1_state") %>% 
	select(-statefip)

ct_race_total <- des %>%
	select(hhwt, statefip, race2) %>% 
	group_by(statefip, race2) %>% 
	summarise(value = survey_total(hhwt)) %>% 
	mutate(name = "Connecticut", level = "1_state", inc_band = "Total") %>% 
	select(-statefip)

hh_by_race_inc_band <- bind_rows(county_hhlds_by_race, county_race_total, ct_hhlds_by_race, ct_race_total) %>%
	ungroup() %>%
	mutate(inc_band = as.factor(inc_band) %>% 
				 	fct_relevel(., "Very low", "Low", "Mid-low", "Mid-high", "High", "Total"),
				 level = as.factor(level)) %>% 
	arrange(level, name, race2) %>% 
	group_by(level, name, race2) %>% 
	calc_shares(group = inc_band, denom = "Total", value = value, moe = value_se)

out$hh_by_inc_band <- hh_by_race_inc_band
```

Considering race/ethnicity of head of household. Statewide, a quarter of all households headed by a Black or Latino person are very low income, earning less than 30% of the county household median income, compared to just over a tenth of households headed by a white person. Some variation exists by county. In the three largest counties, half of white households are high income.

```{r fig.width=10, fig.height=10}
hh_by_race_inc_band %>% 
	filter(inc_band != "Total") %>% 
	mutate(race2 = fct_rev(race2)) %>% 
	ggplot(aes(share, race2, group = race2)) +
	geom_col(aes(fill = inc_band), width = .8, position = position_stack(1)) +
	guides(fill = guide_legend(title = "", reverse = T)) +
	geom_text(aes(label = percent(share, accuracy = 1)),
						position = position_stack(.5), family = "Roboto Condensed") +
	scale_x_continuous(expand = expansion(mult = c(0, 0))) +
	facet_wrap(facets = "name") +
	guides(fill = guide_legend(title = "")) +
	scale_fill_custom() +
	labs(x = "", y = "",
			 title = "Share of households in each income band by race of HOH") +
	theme(panel.grid.major  = element_blank(),
				panel.grid.minor = element_blank(),
				axis.text.y = element_text(colour = "black"),
				axis.text.x = element_blank(),
				legend.position = "bottom",
				plot.title.position = "plot")
```

### Jobs held by household occupants

Retrieved a list of 2018 occ codes from the Census Bureau at
<https://www.census.gov/topics/employment/industry-occupation/guidance/code-lists.html>. 

This table lists the top five occupations, in order from the most numerous, for household inhabitants—so not just heads of household, but all household members, including inhabitants with no work experience in the past 5 years or who have never worked—by household income band by county.

To be honest, this is a little surprising in places. I expected more food service workers in general, and I'm surprised at how many elementary and middle school teachers are workers in higher income households. Either I have the exact wrong impression of how much teachers are paid or it's a common occupation for people whose partners/spouses pull in big money. And yet, #thestruggle: adjuncts and GAs in Tolland County (UConn) getting those minimum wage grad school stipends while profs in New Haven and Middlesex Counties make six figures teaching half the load.

```{r}
des2 <- pums %>%
	filter(hhincome != 9999999, ownershp != "N/A") %>% 
	as_survey_design(., ids = 1, wt = perwt)

occ_lut <- read_csv("../input_data/occ_codes.csv") %>% 
	mutate(occ_code = as.integer(occ_code)) #leading 0s

common_jobs_by_inc_band <- pums %>%
	select(perwt, name, inc_band, occ) %>% 
	group_by(name, inc_band, occ) %>% 
	summarise(workers = sum(perwt)) %>% 
	mutate(level = "2_counties") %>% 
	filter(occ != "0") %>% #0 is "n/a" occ
	group_by(name, inc_band) %>% 
	slice_max(workers, n = 5) %>%
	left_join(occ_lut, by = c("occ" = "occ_code")) %>% 
	select(level, name, inc_band, workers, occ, occ_label)

out$common_jobs_by_inc_band <- common_jobs_by_inc_band

common_jobs_by_inc_band %>% 
	group_by(level, name, inc_band) %>% 
	mutate(rank = order(workers, decreasing = T)) %>% 
	select(name, inc_band, rank, occ_label) %>% 
	pivot_wider(id_cols = c("name", "inc_band"), names_from = "rank", values_from = "occ_label") %>% 
	mutate(`Common occupations` = paste(`1`, `2`, `3`, `4`, `5`, sep = "; ")) %>% 
	select(Name = name, `Income band` = inc_band, `Common occupations`) %>% 
	pivot_wider(id_cols = Name, names_from = "Income band", values_from = "Common occupations") %>% 
	kable(caption = "Common occupations for workers by household income band")
```

## Cost burden by income band

```{r}
county_cb <- des %>%
	select(hhwt, name, inc_band, cost_burden) %>% 
	group_by(name, inc_band, cost_burden) %>% 
	summarise(value = survey_total(hhwt)) %>% 
	mutate(level = "2_counties")

ct_cb <- des %>%
	select(hhwt, statefip, inc_band, cost_burden) %>%
	group_by(statefip, inc_band, cost_burden) %>%
	summarise(value = survey_total(hhwt)) %>%
	mutate(name = "Connecticut", level = "1_state") %>%
	select(-statefip)

cb_by_inc_band <- bind_rows(county_cb, county_hhlds, ct_cb, ct_hhlds) %>%
	mutate(cost_burden = if_else(is.na(cost_burden), "Total", as.character(cost_burden)),
				 cost_burden = as.factor(cost_burden) %>% 
				 	fct_relevel(., "No burden", "Cost-burdened", "Severely cost-burdened", "Total")) %>% 
	ungroup() %>%
	mutate(inc_band = as.factor(inc_band) %>%
				 	fct_relevel(., "Very low", "Low", "Mid-low", "Mid-high", "High"),
				 level = as.factor(level)) %>%
	arrange(level, name, inc_band) %>%
	group_by(level, name, inc_band) %>%
	calc_shares(group = cost_burden, denom = "Total", value = value, moe = value_se)

out$cb_by_inc_band <- cb_by_inc_band
```

No surprise that cost burden rates among very low income households are more than 80%. At the statewide level that's more than 14x the rate of high income households.

It's a little surprising that fully half of mid-low income households (households whose income ranges from $57K-$95K in CT) are cost burdened.

```{r fig.width=8}
cb_by_inc_band %>% 
	mutate(cost_burden = fct_collapse(cost_burden, Burden = c("Cost-burdened", "Severely cost-burdened"))) %>% 
	ungroup() %>% 
	select(-share, -sharemoe, -value_se) %>% 
	group_by(level, name, inc_band, cost_burden) %>% 
	summarise(value = sum(value)) %>% 
	ungroup() %>% 
	group_by(level, name, inc_band) %>% 
	calc_shares(group = cost_burden, denom = "Total", value = value) %>% 
	filter(cost_burden == "Burden") %>% 
	group_by(level) %>% 
	mutate(name = as.factor(name) %>% 
				 	fct_rev()) %>% 
	ggplot(aes(share, name, group = inc_band)) +
	geom_point(aes(color = inc_band), size = 7.5, alpha = .8) +
	geom_text(aes(
		label = percent(share, accuracy = 1)),
		family = "Roboto Condensed", size = 3.55) +
	scale_x_continuous(expand = expansion(mult = c(.025, .1))) +
	guides(color = guide_legend(title = "")) +
	labs(
		x = "",
		y = "",
		title = "Cost-burden rates for households in each income band") +
	scale_color_custom() +
	theme(
		panel.grid.minor = element_blank(),
		panel.grid.major.x = element_blank(),
		legend.position = "bottom",
		plot.title.position = "plot",
		axis.text.x = element_blank(),
		axis.text.y = element_text(colour = "black"))
```

Breaking this down by regular and severe cost burden, in Fairfield and New Haven Counties, about the same share of low income households are cost burdened or severely cost burdened. Two-thirds or more very low income households are severely cost burdened.

**Note, these would add up to 100% if households with no burden were included, so the chart is read as "16% of very low income households in Connecticut are cost burdened and another 70% are severely cost burdened."**

```{r fig.height=8, fig.width=8}
cb_by_inc_band %>% 
	ungroup() %>% 
	filter(!cost_burden %in% c("Total", "No burden")) %>% 
	group_by(level) %>% 
	mutate(name = as.factor(name) %>% 
				 	fct_rev()) %>% 
	ggplot(aes(share, name, group = inc_band)) +
	geom_point(aes(color = inc_band), size = 6.5, alpha = 0.8) +
	geom_text(aes(
		label = percent(share, accuracy = 1)),
		family = "Roboto Condensed", size = 2.75, alpha = 0.8) +
	scale_x_continuous(expand = expansion(mult = c(.025, .1))) +
	facet_grid(rows = "cost_burden", scales = "free", space = "fixed") +
	guides(color = guide_legend(title = "")) +
	labs(
		x = "",
		y = "",
		title = "Rates of burden by burden type for households in each income band",
		caption = "Cost-burdened: spending 30%-50% of household income on housing;\nSeverely cost-burdened: spending more than 50% of household income on housing.") +
	scale_color_custom() +
	theme(
		panel.grid.minor = element_blank(),
		panel.grid.major.x = element_blank(),
		legend.position = "bottom",
		plot.title.position = "plot",
		axis.text.x = element_blank(),
		axis.text.y = element_text(colour = "black"))
```

Quick diversion: is the SCB rate among very low income households partially explained by some of these households having housing costs and no/negative negative income?

By definition, the household is in the "very low income" income band if household income is $0 or less because that's less than 30% CMI. There are about 15K poor households with no or negative income and some nonzero housing cost, making them "severely cost burdened" by definition. These ~15K units make up about 7% of all very low income households, which is not insignificant, but it's not the sole motivator for high SCB rates in this income band.

```{r}
des %>%
	mutate(income = if_else(hhincome == 0, "no_income", "positive_income")) %>% 
	mutate(income = if_else(hhincome < 0, "negative_income", income)) %>% 
	select(hhwt, income, cost_burden) %>% 
	group_by(income, cost_burden) %>% 
	filter(income != "positive_income", cost_burden == "Severely cost-burdened") %>% 
	summarise(households = survey_total(hhwt))
```
## Average housing-cost-to-income ratio for each band

```{r}
avg_cost_ratio_county <- pums %>%
	filter(pernum == "1", hhincome != 9999999, ownershp != "N/A") %>%
	select(hhwt, name, inc_band, cb) %>%
	mutate(mult = cb * hhwt) %>% 
	group_by(name, inc_band) %>% 
	summarise(wm_cb = sum(mult)/sum(hhwt)) %>% 
	mutate(level = "2_counties")

avg_cost_ratio_ct <- pums %>%
	filter(pernum == "1", hhincome != 9999999, ownershp != "N/A") %>%
	select(hhwt, inc_band, cb) %>%
	mutate(mult = cb * hhwt) %>% 
	group_by(inc_band) %>% 
	summarise(wm_cb = sum(mult)/sum(hhwt)) %>% 
	mutate(name = "Connecticut", level = "1_state")

avg_cost_ratio_inc_band <- bind_rows(avg_cost_ratio_county, avg_cost_ratio_ct)

out$avg_cost_ratio_inc_band <- avg_cost_ratio_inc_band
```

Urban's DC study found that higher income households paid about 12% income to housing. In CT it's about 16%. For a household with $200K in income, that's about $2667/month in housing costs, which I just don't think is that high considering there are some kinda crappy 2BRs in East Rock that go for that much.

For a household at the lower end of CT's affluent band, earning about $114K, 16% of income to housing cost would be about $1520, which as a renter strikes me as unbelievably low for someone of those means. It's the same as 30% for someone earning $60K. Why is that OK?

**7/15:** Talked with the team and I think we're going to use 30% for all income bands rather than the sliding scale.

```{r}
avg_cost_ratio_inc_band %>% 
	group_by(level) %>% 
	mutate(name = as.factor(name) %>% 
				 	fct_rev()) %>% 
	mutate(wm_cb = round(wm_cb, 3)) %>% 
	ggplot(aes(wm_cb, name, group = inc_band)) +
	geom_point(aes(color = inc_band), size = 6.5, alpha = 0.8) +
	geom_vline(xintercept = .3, color = "gray60", size = 0.5, linetype = "23") +
	geom_vline(xintercept = .5, color = "gray60", size = 0.5, linetype = "23") +
	geom_text(aes(
		label = percent(wm_cb, accuracy = 1)),
		family = "Roboto Condensed", size = 2.75, alpha = 0.8) +
	scale_x_continuous(breaks = c(.3, .5),
										 labels = c("Cost burden", "Severe cost burden"),
										 expand = expansion(mult = c(.025, .1))) +
	guides(color = guide_legend(title = "")) +
	labs(
		x = "",
		y = "",
		title = str_wrap("Average housing-cost-to-income-ratio by income band", 60),
		caption = "Weighted mean of cost ratio to IPUMS household weight") +
	scale_color_custom() +
	theme(
		panel.grid.minor = element_blank(),
		panel.grid.major.x = element_blank(),
		legend.position = "bottom",
		plot.title.position = "plot",
		axis.text.x = element_text(colour = "black"),
		axis.text.y = element_text(colour = "black"))
```

One last thing real quick... what's the average *actual* housing cost for each band?

```{r}
avg_cost_county_owners <- pums %>%
	filter(pernum == "1", hhincome != 9999999, ownershp == "Owned or being bought (loan)") %>%
	select(hhwt, name, inc_band, owncost) %>%
	mutate(mult = owncost * hhwt) %>% 
	group_by(name, inc_band) %>% 
	summarise(wm_cost = sum(mult)/sum(hhwt)) %>% 
	mutate(tenure = "owner", level = "2_counties")

avg_cost_county_renters <- pums %>%
	filter(pernum == "1", hhincome != 9999999, ownershp == "Rented") %>%
	select(hhwt, name, inc_band, rentgrs) %>%
	mutate(mult = rentgrs * hhwt) %>% 
	group_by(name, inc_band) %>% 
	summarise(wm_cost = sum(mult)/sum(hhwt)) %>% 
	mutate(tenure = "renter", level = "2_counties")

avg_cost_ct_owners <- pums %>%
  filter(pernum == "1", hhincome != 9999999, ownershp == "Owned or being bought (loan)") %>%
	select(hhwt, inc_band, owncost) %>%
	mutate(mult = owncost * hhwt) %>% 
	group_by(inc_band) %>% 
	summarise(wm_cost = sum(mult)/sum(hhwt)) %>% 
	mutate(tenure = "owner", name = "Connecticut", level = "1_state")

avg_cost_ct_renters <- pums %>%
	filter(pernum == "1", hhincome != 9999999, ownershp == "Rented") %>%
	select(hhwt, inc_band, rentgrs) %>%
	mutate(mult = rentgrs * hhwt) %>% 
	group_by(inc_band) %>% 
	summarise(wm_cost = sum(mult)/sum(hhwt)) %>% 
	mutate(tenure = "renter", name = "Connecticut", level = "1_state")

avg_cost_inc_band <- bind_rows(avg_cost_county_renters, avg_cost_county_owners, avg_cost_ct_renters, avg_cost_ct_owners)

out$avg_cost_inc_band <- avg_cost_inc_band
```

Lots of competition for renters in the range between $1000 and $1500, and for homeowners in the $1200-$1500 range. The tightness of the clusters by county are also interesting.

```{r fig.height=8, fig.width=8}
avg_cost_inc_band %>% 
	group_by(level) %>% 
	mutate(name = as.factor(name) %>% 
				 	fct_rev(),
				 tenure = as.factor(tenure)) %>% 
	mutate(wm_cost = round(wm_cost/1000, 1)) %>% 
	ggplot(aes(wm_cost, name, group = inc_band)) +
	geom_point(aes(color = inc_band), size = 6.5, alpha = 0.8) +
	geom_text(aes(
		label = dollar(wm_cost, accuracy = .1)),
		family = "Roboto Condensed", size = 3, alpha = 0.8) +
	scale_x_continuous(expand = expansion(mult = c(.025, .025))) +
	facet_grid(rows = vars(tenure), scales = "fixed", space = "fixed") +
	guides(color = guide_legend(title = "")) +
	labs(
		x = "Monthly housing cost (thousands)",
		y = "",
		title = str_wrap("Average housing costs by tenure and income band", 60),
		caption = "Weighted mean of cost to IPUMS household weight, includes $0 housing costs") +
	scale_color_custom() +
	theme(
		panel.grid.minor = element_blank(),
		panel.grid.major.x = element_blank(),
		legend.position = "bottom",
		plot.title.position = "plot",
		axis.text.x = element_blank(),
		axis.text.y = element_text(colour = "black"))
```

So I do want to look at how many people from each INCOME band are living in each COST band.

## Affordable housing costs to households in each band

Some future iteration of this notebook should find a way to combine this table with the chart above, but a couple interesting things stand out. Very low income renters are often spending their "affordable" amount, but very low income homeowners spend more. Depending on how much more, I'm on the fence about considering this a bad thing necessarily, since the benefits of home ownership may outweigh an extra $100-$200 per month above the affordable threshold, but $300 or more becomes much more challenging to maintain. A few hundred bucks a month over 30% of income, which is already a huge chunk, is the difference between scraping together the mortgage payment and an unexpected expense like a medical bill or car repair.

Almost all middle-to-high income renters are paying below their affordable threshold. As was shown above, higher income people like to rent in lower cost bands. The chart above and table below just show how much lower they rent. But low-bar slow clap for high income FC homeowners paying their 30%.

```{r}
affordable_cost_table <- minc %>% 
	bind_rows(ctminc) %>% 
	select(-countyfip) %>% 
	mutate(vl = minc * .5,
				 l = minc * .75,
				 ml = minc * 1.25, 
				 mh = minc * 1.5) %>% 
	select(-minc) %>% 
	pivot_longer(cols = vl:mh, names_to = "inc_band", values_to = "income") %>% 
	mutate(income = round(income, 0),
				 affordable_hcost = round(income / 12 * .3, 0)) %>% 
	select(name, inc_band, affordable_hcost) %>% 
	mutate(affordable_hcost = comma(affordable_hcost, accuracy = 1)) %>% 
	pivot_wider(id_cols = name, names_from = inc_band, values_from = affordable_hcost) %>% 
	mutate(`Very low` = paste("Less than $", vl, sep = ""),
				 Low = paste("Between $", vl, " and $", l, sep = ""),
				 `Mid-low` = paste("Between $", l, " and $", ml, sep = ""),
				 `Mid-high` = paste("Between $", ml, " and $", mh, sep = ""),
				 High = paste("More than $", mh, sep = ""))

kable(affordable_cost_table %>% 
				select(Name = name, `Very low`:High),
			caption = "Affordable monthly housing cost ranges by income band and area")
```

## Housing units in those cost bands

*Notes for myself: Total up occupied units (renter + owner, any reason to separate?) and vacant units available in each cost band. Occupied units will go by the cost paid (rentgrs and owncost), vacant by contract rent and mortgage payment estimate generated using some average mortgage rate for CT. Need a new PUMS file in hierarchical format, widdled down to household level.*

```{r}
hddi <- read_ipums_ddi("../input_data/usa_00040.xml")

cost_bands <- minc %>% 
	bind_rows(ctminc) %>% 
	select(-countyfip) %>% 
	mutate(vl = round((minc * .5 / 12 * .3), 0),
				 l = round((minc * .75 / 12 * .3), 0),
				 ml = round((minc * 1.25 / 12 * .3), 0), 
				 mh = round((minc * 1.5 / 12 * .3), 0)) %>% 
	select(-minc)

hpums <- read_ipums_micro(hddi, verbose = F) %>% 
	filter(RECTYPE == "H") %>% 
	mutate_at(vars(OWNERSHP, OWNERSHPD, VACANCY), as_factor) %>% 
	mutate_at(vars(OWNCOST, RENT, RENTGRS), as.numeric) %>% 
	janitor::clean_names() %>% 
	left_join(minc, by = "countyfip") %>% 
	left_join(cost_bands, by = "name")
	
occ_des <- hpums %>%
	filter(vacancy == "N/A", ownershp != "N/A") %>% 
	as_survey_design(., ids = 1, wt = hhwt)

own_occ_cost_bands <- occ_des %>%
	filter(owncost != 99999) %>% 
	select(hhwt, name, owncost, vl, l, ml, mh) %>% 
	group_by(name) %>% 
	mutate(tenure = "owner_occupied",
				 very_low = between(owncost, 0, (vl - 1)),
				 low = between(owncost, vl, (l - 1)),
				 mid_low = between(owncost, l, (ml - 1)),
				 mid_high = between(owncost, ml, (mh - 1)),
				 high = between(owncost, mh, Inf)) %>% 
	ungroup() %>% 
	group_by(name, tenure, very_low, low, mid_low, mid_high, high) %>% 
	summarise(units = survey_total(hhwt)) %>% 
	pivot_longer(cols = very_low:high, names_to = "cost_band") %>% 
	filter(value == T) %>% 
	select(name, tenure, cost_band, units, units_se)

rent_occ_cost_bands <- occ_des %>%
	filter(owncost == 99999) %>% 
	select(hhwt, name, rentgrs, vl, l, ml, mh) %>% 
	group_by(name) %>% 
	mutate(tenure = "renter_occupied",
				 very_low = between(rentgrs, 0, (vl - 1)),
				 low = between(rentgrs, vl, (l - 1)),
				 mid_low = between(rentgrs, l, (ml - 1)),
				 mid_high = between(rentgrs, ml, (mh - 1)),
				 high = between(rentgrs, mh, Inf)) %>% 
	ungroup() %>% 
	group_by(name, tenure, very_low, low, mid_low, mid_high, high) %>% 
	summarise(units = survey_total(hhwt)) %>% 
	pivot_longer(cols = very_low:high, names_to = "cost_band") %>% 
	filter(value == T) %>% 
	select(name, tenure, cost_band, units, units_se)

occ_cost_bands <- bind_rows(own_occ_cost_bands, rent_occ_cost_bands)
```

Here's a quick crappy table of the occupied units by cost band and county. Still working on this.

```{r}
kable(occ_cost_bands)
```

```{r}
vac_des <- hpums %>%
	filter(vacancy == "For rent or sale") %>% 
	as_survey_design(., ids = 1, wt = hhwt)
#for vacant units, use 'for rent or sale', and use rent for cost
# will need to use the base rate for home loans to determine what the mortgage cost would be for a for-sale home
```

## Households who need housing in each cost band

To get a table of gaps and surpluses, I think I need to determine how many units are needed in each cost band (so, by default this will be the number of households in each income band if low income households should pay low income prices, right?), then count up the number of households whose costs are in each cost band and add the vacants by contract and mortgage costs. So how many in each income band, vs. how many in each cost band. Seems legit?

## Add homeless?
Not sure where to get good data... PIT counts by county? Mark suggests https://cceh.org/data/interactive/