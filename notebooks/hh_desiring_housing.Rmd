---
title: "Households desiring housing"
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = T, message = F, warning = F, echo = F)
```

```{r lib}
library(ipumsr)
library(tidyverse)
library(srvyr)
library(tidycensus)
library(hrbrthemes)
library(camiller)
library(scales)
library(kableExtra)
```

```{r gg etc}
theme_set(theme_ipsum_rc())

#this theme is better when reverse is standard so poor != red, but also this theme sucks by default because it's based on mineral water, but here we are.
pal <- pal <- rev(LaCroixColoR::lacroix_palette(name = "Pamplemousse", n = 5, type = "discrete"))

scale_fill_custom <- function(palette = pal, rev = F) {
  if (rev) {
    scale_fill_manual(values = rev(pal))
  } else {
    scale_fill_manual(values = pal)
  }
}

scale_color_custom <- function(palette = pal, rev = F) {
  if (rev) {
    scale_color_manual(values = rev(pal))
  } else {
    scale_color_manual(values = pal)
  }
}
```

This notebook needs a better name. "Households desiring housing" to me suggests a household wants to move, not that they're unable to afford housing. Maybe just "gaps in housing units available to households by income band" or something? Kind of a mouthful...

There's a lot going on in this notebook:

* Count and share of households by income band by area
    * **Divisions of county median income make the most sense because HUD regions (HMFAs) cross PUMA and county lines. Brought up with Urban on 7/8 and they will make a call soon, so I'll move forward with what I have for now.**
    * Rounded to pretty numbers for legibility?
* The kinds of occupations/jobs those residents work in
    * Not exactly germane to the conversation unless we're talking about wage reform, but brings the context back down to earth...
* Count and share of households in each band that are cost-burdened (T2 in DC report)
* The approximate monthly housing cost for an affordable unit for each income band.
    * Rounded to pretty numbers for legibility?
* Count and share of units by those cost bands in the area (T3 in DC report).
* Number of housing units needed for each cost band so each household would have an affordable housing cost, vs. the actual count of units in those cost bands (F19 in DC report)
* For each income band, the number of households that can/cannot afford to pay more, * Count of vacant units in each cost band (F20 in DC report).


## Establish groups

Starting by using county median incomes (CMI), then income bands like we did in the Community Index reports...

* poor: < 0.5 CMI
* low-income: [0.5–0.75) CMI
* middle-income: [0.75–1.25) CMI
* high-income: [1.25–1.50) CMI
* affluent: >= 1.5 CMI

Cost-burden in predictable breaks:

* No burden: Less than 30% income to housing
* Cost-burdened: 30%-50% income to housing
* Severely cost-burdened: More than 50% income to housing

And race/ethnicity into a few major categories so we can look at it by county:

* White (NH)
* Black (NH)
* Latino (any race)
* All others (grouped)

```{r data prep}
minc <- get_acs(
  	geography = "county",
	  table = "B19013",
  	state = 09,
	  cache_table = T) %>% 
	arrange(GEOID) %>% 
	mutate(countyfip = seq(from = 1, to = 15, by = 2),
				 name = str_remove(NAME, ", Connecticut")) %>% 
	select(countyfip, name, minc = estimate)

ddi <- read_ipums_ddi("../input_data/usa_00038.xml")

pums <- read_ipums_micro(ddi, verbose = F)  %>% 
	mutate_at(vars(YEAR, PUMA, OWNERSHP, OWNERSHPD, RACE, RACED, HISPAN, HISPAND), as_factor) %>% 
	mutate_at(vars(PERWT, HHWT), as.numeric) %>% 
	mutate_at(vars(HHINCOME, OWNCOST, RENTGRS, OCC), as.integer) %>% 
	janitor::clean_names() %>% 
	left_join(minc, by = "countyfip") %>% 
	mutate(ratio = hhincome / minc) %>% 
	mutate(
		inc_band = cut(
			ratio,
			breaks = c(-Inf, 0.5, 0.75, 1.25, 1.5, Inf),
			labels = c("Poor", "Low", "Middle", "High", "Affluent"),
			include.lowest = T, right = F)) %>% 
	mutate(
		inc_band = as.factor(inc_band) %>%
			fct_relevel(., "Poor", "Low", "Middle", "High", "Affluent")) %>% 
	mutate(cb = if_else(ownershp == "Rented", (rentgrs * 12) / hhincome, 99999)) %>% 
	mutate(cb = if_else(ownershp == "Owned or being bought (loan)", (owncost * 12) / hhincome, cb)) %>%
	# if rent is 0 and income is 0, no burden
	mutate(cb = if_else((rentgrs == 0 & hhincome == 0), 0, cb)) %>% 
	#if income is 0 and rent is >0, burden
	mutate(
		cost_burden = cut(
			cb,
			breaks = c(-Inf, .3, .5, Inf),
			labels = c("No burden", "Cost-burdened", "Severely cost-burdened"),
			include.lowest = T, right = F)) %>% 
		mutate(race2 = if_else(hispan == "Not Hispanic", as.character(race), "Latino")) %>% 
	mutate(race2 = as.factor(race2) %>% 
				 	fct_recode(Black = "Black/African American/Negro") %>%
				 	fct_other(keep = c("White", "Black", "Latino"), other_level = "Other race") %>%
				 	fct_relevel("White", "Black", "Latino", "Other race"))

des <- pums %>%
	filter(pernum == "1", hhincome != 9999999, ownershp != "N/A") %>% 
	as_survey_design(., ids = 1, wt = hhwt)

out <- list()
```

```{r hh by inc band}
county_hhlds <- des %>%
	select(hhwt, name, inc_band) %>% 
	group_by(name, inc_band) %>% 
	summarise(value = survey_total(hhwt)) %>% 
	mutate(level = "2_counties")

county_total <- des %>%
	select(hhwt, name) %>% 
	group_by(name) %>% 
	summarise(value = survey_total(hhwt)) %>% 
	mutate(inc_band = "Total") %>% 
	mutate(level = "2_counties")

ct_hhlds <- des %>%
	select(hhwt, statefip, inc_band) %>% 
	group_by(statefip, inc_band) %>% 
	summarise(value = survey_total(hhwt)) %>% 
	mutate(name = "Connecticut", level = "1_state") %>% 
	select(-statefip)

ct_total <- des %>%
	select(hhwt, statefip) %>% 
	group_by(statefip) %>% 
	summarise(value = survey_total(hhwt)) %>% 
	mutate(name = "Connecticut", level = "1_state", inc_band = "Total") %>% 
	select(-statefip)

hh_by_inc_band <- bind_rows(county_hhlds, county_total, ct_hhlds, ct_total) %>%
	ungroup() %>%
	mutate(inc_band = as.factor(inc_band) %>% 
				 	fct_relevel(., "Poor", "Low", "Middle", "High", "Affluent", "Total"),
				 level = as.factor(level)) %>% 
	arrange(level, name) %>% 
	group_by(level, name) %>% 
	calc_shares(group = inc_band, denom = "Total", value = value, moe = value_se)

out$hh_by_inc_band <- hh_by_inc_band
```

## Define income bands

Would it be preferable to set these as prettier breaks, or use the CT numbers for all counties?

**A better chart here would be color coded segments indicating each group's range, with each area on a new row. Could use arrow ends or something to communicate the top and bottom. Come back to this idea.**

```{r inc table}
ctminc <- get_acs(geography = "state", state = 09, table = "B19013") %>% 
	select(name = NAME, minc = estimate)

income_table <- minc %>% 
	bind_rows(ctminc) %>% 
	mutate(p = comma(round(minc * .5, 0), accuracy = 1),
				 l = comma(round(minc * .75, 0), accuracy = 1),
				 m = comma(round(minc * 1.25, 0), accuracy = 1), 
				 h = comma(round(minc * 1.5, 0), accuracy = 1),
				 Poor = paste("Less than $", p, sep = ""),
				 Low = paste("Between $", p, " and $", l, sep = ""),
				 Middle = paste("Between $", l, " and $", m, sep = ""),
				 High = paste("Between $", m, " and $", h, sep = ""),
				 Affluent = paste("More than $", h, sep = "")) %>% 
	select(Name = name, Poor:Affluent)

kable(income_table, caption = "Income ranges by income band and area")
```

## Count/share of households by income band

More than half a million households in CT (40% of all households) are poor or low-income, earning less than three-quarters of their county's median income. A similar share are affluent or high income, earning  125% or more of their county's median income. Just one in five households statewide are considered middle income by this definition.

```{r}
hh_by_inc_band %>% 
	filter(inc_band != "Total", name == "Connecticut") %>% 
	mutate(inc_band = fct_rev(inc_band)) %>% 
	ggplot(aes(value, inc_band)) +
	geom_col(aes(fill = inc_band), width = .7, position = position_dodge(.8)) +
	scale_x_continuous(
		expand = expansion(mult = c(0, 0.1)),
		labels = scales::comma) +
	geom_text(aes(
		label = comma(value, accuracy = 1)),
		position = position_dodge(.8), hjust = 1, family = "Roboto Condensed", size = 3.75) +
	guides(fill = guide_legend(title = "")) +
	labs(
		x = "",
		y = "",
		title = "Number of households in each income band",
		subtitle = "Connecticut") +
	scale_fill_custom() +
	theme(
		panel.grid.minor = element_blank(),
		panel.grid.major = element_blank(),
		legend.position = "none",
		plot.title.position = "plot",
		axis.text.x = element_blank(),
		axis.text.y = element_text(colour = "black"),
		strip.text.y = element_blank())
```

```{r}
kable(hh_by_inc_band %>% 
	mutate(level = fct_rev(level)) %>% 
	arrange(level) %>% 
	select(Name = name, inc_band, value) %>% 
	mutate(value = comma(value, accuracy = 1)) %>% 
	pivot_wider(id_cols = Name, names_from = "inc_band") %>% 
	select(Name, Poor:Affluent, Total))
```

The income distributions are fairly consistent, even in the more rural counties. This trend mirrors national trends with middle income households being squeezed out by high and low income households.

```{r fig.width=8, fig.height=8}
hh_by_inc_band %>% 
	filter(inc_band != "Total") %>% 
	group_by(level) %>% 
	mutate(name = as.factor(name) %>% 
				 	fct_rev()) %>% 
	ggplot(aes(name, share, group = name)) +
	geom_col(aes(fill = inc_band), width = .7, position = position_stack(1)) +
	coord_flip() +
	geom_text(aes(label = percent(share, accuracy = 1)),
						position = position_stack(.5), family = "Roboto Condensed") +
	scale_y_continuous(expand = expansion(mult = c(0, 0))) +
	scale_fill_custom() +
	guides(fill = guide_legend(title = "")) +
	labs(x = "", y = "",
			 title = "Share of households in each income band by state and county") +
	theme(panel.grid.major  = element_blank(),
				panel.grid.minor = element_blank(),
				axis.text.y = element_text(colour = "black"),
				axis.text.x = element_blank(),
				legend.position = "bottom",
				plot.title.position = "plot")
```

## Household characteristics by income bands

### Race breakdowns

```{r}
county_hhlds_by_race <- des %>%
	select(hhwt, name, inc_band, race2) %>% 
	group_by(name, inc_band, race2) %>% 
	summarise(value = survey_total(hhwt)) %>% 
	mutate(level = "2_counties")

county_race_total <- des %>%
	select(hhwt, name, race2) %>% 
	group_by(name, race2) %>% 
	summarise(value = survey_total(hhwt)) %>% 
	mutate(inc_band = "Total") %>% 
	mutate(level = "2_counties")

ct_hhlds_by_race <- des %>%
	select(hhwt, statefip, inc_band, race2) %>% 
	group_by(statefip, inc_band, race2) %>% 
	summarise(value = survey_total(hhwt)) %>% 
	mutate(name = "Connecticut", level = "1_state") %>% 
	select(-statefip)

ct_race_total <- des %>%
	select(hhwt, statefip, race2) %>% 
	group_by(statefip, race2) %>% 
	summarise(value = survey_total(hhwt)) %>% 
	mutate(name = "Connecticut", level = "1_state", inc_band = "Total") %>% 
	select(-statefip)

hh_by_race_inc_band <- bind_rows(county_hhlds_by_race, county_race_total, ct_hhlds_by_race, ct_race_total) %>%
	ungroup() %>%
	mutate(inc_band = as.factor(inc_band) %>% 
				 	fct_relevel(., "Poor", "Low", "Middle", "High", "Affluent", "Total"),
				 level = as.factor(level)) %>% 
	arrange(level, name, race2) %>% 
	group_by(level, name, race2) %>% 
	calc_shares(group = inc_band, denom = "Total", value = value, moe = value_se)

out$hh_by_inc_band <- hh_by_race_inc_band
```

Considering race/ethnicity of head of household. Statewide, more than half of all households headed by a Black or Latino person are poor or low income, compared to about a third of households headed by a white person. Some variation exists by county.

```{r fig.width=10, fig.height=10}
hh_by_race_inc_band %>% 
	filter(inc_band != "Total") %>% 
	mutate(race2 = fct_rev(race2)) %>% 
	ggplot(aes(share, race2, group = race2)) +
	geom_col(aes(fill = inc_band), width = .8, position = position_stack(1)) +
	guides(fill = guide_legend(title = "", reverse = T)) +
	geom_text(aes(label = percent(share, accuracy = 1)),
						position = position_stack(.5), family = "Roboto Condensed") +
	scale_x_continuous(expand = expansion(mult = c(0, 0))) +
	facet_wrap(facets = "name") +
	guides(fill = guide_legend(title = "")) +
	scale_fill_custom() +
	labs(x = "", y = "",
			 title = "Share of households in each income band by race of HOH") +
	theme(panel.grid.major  = element_blank(),
				panel.grid.minor = element_blank(),
				axis.text.y = element_text(colour = "black"),
				axis.text.x = element_blank(),
				legend.position = "bottom",
				plot.title.position = "plot")
```

### Jobs held by household occupants

Retrieved a list of 2018 occ codes from the Census Bureau at
<https://www.census.gov/topics/employment/industry-occupation/guidance/code-lists.html>. 

This table lists the top five occupations, in order from the most numerous, for household inhabitants—so not just heads of household, but all household members, including inhabitants with no work experience in the past 5 years or who have never worked—by household income band by county.

To be honest, this is a little surprising in places. I expected more food service workers in general, and I'm surprised at how many elementary and middle school teachers are workers in higher income households. Either I have the exact wrong impression of how much teachers are paid or it's a common occupation for people whose partners/spouses pull in big money. And yet, #thestruggle: adjuncts and GAs in Tolland County (UConn) getting those minimum wage grad school stipends while profs in New Haven and Middlesex Counties make six figures teaching half the load.

```{r}
des2 <- pums %>%
	filter(hhincome != 9999999, ownershp != "N/A") %>% 
	as_survey_design(., ids = 1, wt = perwt)

occ_lut <- read_csv("../input_data/occ_codes.csv") %>% 
	mutate(occ_code = as.integer(occ_code)) #leading 0s

common_jobs_by_inc_band <- pums %>%
	select(perwt, name, inc_band, occ) %>% 
	group_by(name, inc_band, occ) %>% 
	summarise(workers = sum(perwt)) %>% 
	mutate(level = "2_counties") %>% 
	filter(occ != "0") %>% #0 is "n/a" occ
	group_by(name, inc_band) %>% 
	slice_max(workers, n = 5) %>%
	left_join(occ_lut, by = c("occ" = "occ_code")) %>% 
	select(level, name, inc_band, workers, occ, occ_label)

out$common_jobs_by_inc_band <- common_jobs_by_inc_band

common_jobs_by_inc_band %>% 
	group_by(level, name, inc_band) %>% 
	mutate(rank = order(workers, decreasing = T)) %>% 
	select(name, inc_band, rank, occ_label) %>% 
	pivot_wider(id_cols = c("name", "inc_band"), names_from = "rank", values_from = "occ_label") %>% 
	mutate(`Common occupations` = paste(`1`, `2`, `3`, `4`, `5`, sep = "; ")) %>% 
	select(Name = name, `Income band` = inc_band, `Common occupations`) %>% 
	pivot_wider(id_cols = Name, names_from = "Income band", values_from = "Common occupations") %>% 
	kable(caption = "Common occupations for workers by household income band")
```

## Cost burden by income band

```{r}
county_cb <- des %>%
	select(hhwt, name, inc_band, cost_burden) %>% 
	group_by(name, inc_band, cost_burden) %>% 
	summarise(value = survey_total(hhwt)) %>% 
	mutate(level = "2_counties")

ct_cb <- des %>%
	select(hhwt, statefip, inc_band, cost_burden) %>%
	group_by(statefip, inc_band, cost_burden) %>%
	summarise(value = survey_total(hhwt)) %>%
	mutate(name = "Connecticut", level = "1_state") %>%
	select(-statefip)

cb_by_inc_band <- bind_rows(county_cb, county_hhlds, ct_cb, ct_hhlds) %>%
	mutate(cost_burden = if_else(is.na(cost_burden), "Total", as.character(cost_burden)),
				 cost_burden = as.factor(cost_burden) %>% 
				 	fct_relevel(., "No burden", "Cost-burdened", "Severely cost-burdened", "Total")) %>% 
	ungroup() %>%
	mutate(inc_band = as.factor(inc_band) %>%
				 	fct_relevel(., "Poor", "Low", "Middle", "High", "Affluent"),
				 level = as.factor(level)) %>%
	arrange(level, name, inc_band) %>%
	group_by(level, name, inc_band) %>%
	calc_shares(group = cost_burden, denom = "Total", value = value, moe = value_se)

out$cb_by_inc_band <- cb_by_inc_band
```

No surprise that cost burden rates among poor households are around 80%, at the statewide level that's 20x the rate of affluent households. Too bad I can't do this by town...

What does stand out a bit are the gaps between each group. Moving up the income scale (from lower to higher income) shows a 20-30 percentage point decrease in cost burden rates. Those gains are much smaller from medium to high and from high to affluent income groups. Not like anyone was doubting this before, but this chart essentially says there's not enough housing affordable to low-income households, but there's plenty of housing affordable to mid-to-high income households. More on this below...

```{r fig.width=8}
cb_by_inc_band %>% 
	mutate(cost_burden = fct_collapse(cost_burden, Burden = c("Cost-burdened", "Severely cost-burdened"))) %>% 
	ungroup() %>% 
	select(-share, -sharemoe, -value_se) %>% 
	group_by(level, name, inc_band, cost_burden) %>% 
	summarise(value = sum(value)) %>% 
	ungroup() %>% 
	group_by(level, name, inc_band) %>% 
	calc_shares(group = cost_burden, denom = "Total", value = value) %>% 
	filter(cost_burden == "Burden") %>% 
	group_by(level) %>% 
	mutate(name = as.factor(name) %>% 
				 	fct_rev()) %>% 
	ggplot(aes(share, name, group = inc_band)) +
	geom_point(aes(color = inc_band), size = 7.5, alpha = .8) +
	geom_text(aes(
		label = percent(share, accuracy = 1)),
		family = "Roboto Condensed", size = 3.55) +
	scale_x_continuous(expand = expansion(mult = c(.025, .1))) +
	guides(color = guide_legend(title = "")) +
	labs(
		x = "",
		y = "",
		title = "Cost-burden rates for households in each income band") +
	scale_color_custom() +
	theme(
		panel.grid.minor = element_blank(),
		panel.grid.major.x = element_blank(),
		legend.position = "bottom",
		plot.title.position = "plot",
		axis.text.x = element_blank(),
		axis.text.y = element_text(colour = "black"))
```

```{r fig.height=8, fig.width=8}
cb_by_inc_band %>% 
	ungroup() %>% 
	filter(!cost_burden %in% c("Total", "No burden")) %>% 
	group_by(level) %>% 
	mutate(name = as.factor(name) %>% 
				 	fct_rev()) %>% 
	ggplot(aes(share, name, group = inc_band)) +
	geom_point(aes(color = inc_band), size = 6.5, alpha = 0.8) +
	geom_text(aes(
		label = percent(share, accuracy = 1)),
		family = "Roboto Condensed", size = 2.75, alpha = 0.8) +
	scale_x_continuous(expand = expansion(mult = c(.025, .1))) +
	facet_grid(rows = "cost_burden", scales = "free", space = "fixed") +
	guides(color = guide_legend(title = "")) +
	labs(
		x = "",
		y = "",
		title = "Rates of burden by burden type for households in each income band",
		caption = "Cost-burdened: spending 30%-50% of household income on housing;\nSeverely cost-burdened: spending more than 50% of household income on housing.") +
	scale_color_custom() +
	theme(
		panel.grid.minor = element_blank(),
		panel.grid.major.x = element_blank(),
		legend.position = "bottom",
		plot.title.position = "plot",
		axis.text.x = element_blank(),
		axis.text.y = element_text(colour = "black"))
```

For all households but the poorest, about twice the share of households pay between 30% and 50% of income towards housing than pay more than 50%, the idea being that because middle-to-high income households have more money, they have more choice in what they pay in order to live where they'd like to live. But among poor households, the inverse is true—more poor households pay half or more of their income in rent. Obviously with less money to spend, a higher shares of income go to expenses like housing. But I think the element of choice comes into play here as well. It's that the housing market in CT is anti-poor.

Follow me: obviously there's a paucity of affordable housing because the range of housing costs is both high and narrow, but the market has also exploited the fact that poor households will pay to gain more choice, and has calibrated to what poor households are willing to pay and where. Consider choice as shorthand for typical inputs to a hedonic abstraction for housing—although location is perhaps more important than housing type, amenities, etc., in this regard.

Poor households in CT make up to about $38K/year. By spending half of that income monthly on housing, they're paying about $1,500 per month, which is the lower end of what middle-income people should be paying housing that's affordable. I think we hear this every time someone proposes a development in New Haven at market-rate prices to attract "young professionals" who by and large can already choose to live here or elsewhere and who are less restricted by unit cost and more sensitive to amenities or location. But the value of that choice isn't necessarily restricted to middle-to-high income households. With some town zoning boards blocking sub-market rate housing, thereby restricting supply, and other towns concentrating housing affordable to poor households in just a few neighborhoods, restricting location, if a poor household wants to have any choice in where they live at all, they're stuck paying middle-income rent in order to gain the value of that expanded choice of location/amenities/etc.

Anyway, it'll be interesting to see what households in each income band are paying and where vacancies exist by cost band to test this theory. I think the magic number is the low-end of middle income cost bands as the sweet spot between what people who expect choice want to be wooed for and what people who pay for choice can pay up to.

Quick diversion: is the SCB rate among poor households partially explained by some of these households having housing costs and no/negative negative income?

By definition, the household is "poor" if household income is $0 or less because that's less than 50% CMI. There are about 15K poor households with no or negative income. About 6K of those have no housing costs and thus no burden. The remaining 9K (shown below) are severely cost-burdened by definition. Although there are 2-3K of these households in the urban counties, they only account for 2-3% of poor households in those areas. In other words, no, these households are not driving the trend in SCB.

```{r}
des %>%
	mutate(income = if_else(hhincome == 0, "no_income", "positive_income")) %>% 
	mutate(income = if_else(hhincome < 0, "negative_income", income)) %>% 
	select(hhwt, name, income, cost_burden) %>% 
	group_by(name, income, cost_burden) %>% 
	filter(income != "positive_income", cost_burden == "Severely cost-burdened") %>% 
	summarise(households = survey_total(hhwt))
```

## Housing costs affordable to household within each band

Using the income bands above, these are the 30% rent cutoff points, so the monthly affordable cost by income band. We'll call these cost bands.

```{r}
affordable_cost_table <- minc %>% 
	bind_rows(ctminc) %>% 
	select(-countyfip) %>% 
	mutate(p = minc * .5,
				 l = minc * .75,
				 m = minc * 1.25, 
				 h = minc * 1.5) %>% 
	select(-minc) %>% 
	pivot_longer(cols = p:h, names_to = "inc_band", values_to = "income") %>% 
	mutate(income = round(income, 0),
				 affordable_hcost = round(income / 12 * .3, 0)) %>% 
	select(name, inc_band, affordable_hcost) %>% 
	mutate(affordable_hcost = comma(affordable_hcost, accuracy = 1)) %>% 
	pivot_wider(id_cols = name, names_from = inc_band, values_from = affordable_hcost) %>% 
	mutate(Poor = paste("Less than $", p, sep = ""),
				 Low = paste("Between $", p, " and $", l, sep = ""),
				 Middle = paste("Between $", l, " and $", m, sep = ""),
				 High = paste("Between $", m, " and $", h, sep = ""),
				 Affluent = paste("More than $", h, sep = ""))

kable(affordable_cost_table %>% 
				select(Name = name, Poor:Affluent),
			caption = "Affordable monthly housing cost ranges by income band and area")
```

## Housing units in those cost bands

Using a new PUMS file in hierarchical format... never done that before so we'll see.

```{r}
hddi <- read_ipums_ddi("../input_data/usa_00039.xml")

cost_bands <- minc %>% 
	bind_rows(ctminc) %>% 
	select(-countyfip) %>% 
	mutate(p = round((minc * .5 / 12 * .3), 0),
				 l = round((minc * .75 / 12 * .3), 0),
				 m = round((minc * 1.25 / 12 * .3), 0), 
				 h = round((minc * 1.5 / 12 * .3), 0)) %>% 
	select(-minc)

hpums <- read_ipums_micro(hddi, verbose = F) %>% 
	filter(RECTYPE == "H") %>% 
	mutate_at(vars(OWNERSHP, OWNERSHPD, VACANCY), as_factor) %>% 
	mutate_at(vars(OWNCOST, RENT, RENTGRS), as.numeric) %>% 
	janitor::clean_names() %>% 
	left_join(minc, by = "countyfip") %>% 
	left_join(cost_bands, by = "name")
	
occ_des <- hpums %>%
	filter(vacancy == "N/A", ownershp != "N/A") %>% 
	as_survey_design(., ids = 1, wt = hhwt)

own_occ_cost_bands <- occ_des %>%
	filter(owncost != 99999) %>% 
	select(hhwt, name, owncost, p, l, m, h) %>% 
	group_by(name) %>% 
	mutate(tenure = "owner_occupied",
				 poor = between(owncost, 0, (p - 1)),
				 low = between(owncost, p, (l - 1)),
				 middle = between(owncost, l, (m - 1)),
				 high = between(owncost, m, (h - 1)),
				 affluent = between(owncost, h, Inf)) %>% 
	ungroup() %>% 
	group_by(name, tenure, poor, low, middle, high, affluent) %>% 
	summarise(units = survey_total(hhwt)) %>% 
	pivot_longer(cols = poor:affluent, names_to = "cost_band") %>% 
	filter(value == T) %>% 
	select(name, tenure, cost_band, units, units_se)

rent_occ_cost_bands <- occ_des %>%
	filter(owncost == 99999) %>% 
	select(hhwt, name, rentgrs, p, l, m, h) %>% 
	group_by(name) %>% 
	mutate(tenure = "renter_occupied",
				 poor = between(rentgrs, 0, (p - 1)),
				 low = between(rentgrs, p, (l - 1)),
				 middle = between(rentgrs, l, (m - 1)),
				 high = between(rentgrs, m, (h - 1)),
				 affluent = between(rentgrs, h, Inf)) %>% 
	ungroup() %>% 
	group_by(name, tenure, poor, low, middle, high, affluent) %>% 
	summarise(units = survey_total(hhwt)) %>% 
	pivot_longer(cols = poor:affluent, names_to = "cost_band") %>% 
	filter(value == T) %>% 
	select(name, tenure, cost_band, units, units_se)

occ_cost_bands <- bind_rows(own_occ_cost_bands, rent_occ_cost_bands)
	
vac_des <- hpums %>%
	filter(vacancy == "For rent or sale") %>% 
	as_survey_design(., ids = 1, wt = hhwt)

#for vacant units, use 'for rent or sale', and use rent for cost
```