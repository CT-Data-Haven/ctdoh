---
title: "Households desiring housing"
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = T, message = F, warning = F, echo = F)
```

```{r lib}
library(ipumsr)
library(tidyverse)
library(srvyr)
library(tidycensus)
library(hrbrthemes)
library(camiller)
library(scales)
library(kableExtra)
```

```{r}
source("../_utils/town2county.R")
```

```{r gg etc}
theme_set(theme_ipsum_rc())

pal <- c("#92c9c5", "#ffe37e", "#ffac8f", "#cb94c4", "#5e63af")
	
#rev(LaCroixColoR::lacroix_palette(name = "Pamplemousse", n = 5, type = "discrete"))

scale_fill_custom <- function(palette = pal, rev = F) {
  if (rev) {
    scale_fill_manual(values = rev(pal))
  } else {
    scale_fill_manual(values = pal)
  }
}

scale_color_custom <- function(palette = pal, rev = F) {
  if (rev) {
    scale_color_manual(values = rev(pal))
  } else {
    scale_color_manual(values = pal)
  }
}
```

This notebook needs a better name. "Households desiring housing" to me suggests a household wants to move, not that they're unable to afford housing. Maybe just "gaps in housing units available to households by income band" or something? Kind of a mouthful...

There's a lot going on in this notebook:

* Count and share of households by income band by area
    * Rounded to pretty numbers for legibility?
* The kinds of occupations/jobs those residents work in
    * Not exactly germane to the conversation unless we're talking about wage reform, but brings the context back down to earth...
* Count and share of households in each band that are cost-burdened (T2 in DC report)
* Average (median?) housing-cost-to-income ratio for each income band
* The approximate monthly housing cost for an affordable unit (30%) for each income band.
    * Rounded to pretty numbers for legibility?
* Count and share of units by those cost bands in the area (T3 in DC report).
* Number of housing units needed for each cost band so each household would have an affordable housing cost, vs. the actual count of units in those cost bands (F19 in DC report)
* For each income band, the number of households that can/cannot afford to pay more
* Count of vacant units in each cost band (F20 in DC report).


## Establish groups

After discussion with team on 7/15 we are settled with using median hh income by county and the groupings below:

**7/21: want to bring up to the team tomorrow adding a very high income category

* very low income: <= 0.3 CMI
* low income: (0.3–0.5] CMI
* mid-low income: (0.5–.8] CMI
* mid-high income: (.8–1.2] CMI
* high income: (1.2–2.0] CMI
* very high income: > 2.0 CMI

Cost-burden in predictable breaks:

* No burden: Less than 30% income to housing
* Cost-burdened: 30%-50% income to housing
* Severely cost-burdened: More than 50% income to housing

And race/ethnicity into a few major categories so we can look at it by county:

* White (NH)
* Black (NH)
* Latino (any race)
* All others (grouped)

And for everyone we're considering affordable 30%, not the sliding scale they used in the DC report.

```{r data prep}
minc <- get_acs(
  	geography = "county",
	  table = "B19013",
  	state = 09,
	  cache_table = T) %>% 
	arrange(GEOID) %>% 
	mutate(countyfip = seq(from = 1, to = 15, by = 2),
				 name = str_remove(NAME, ", Connecticut")) %>% 
	select(countyfip, name, minc = estimate)

ddi <- read_ipums_ddi("../input_data/usa_00038.xml")

pums <- read_ipums_micro(ddi, verbose = F)  %>% 
	mutate_at(vars(YEAR, PUMA, OWNERSHP, OWNERSHPD, RACE, RACED, HISPAN, HISPAND), as_factor) %>% 
	mutate_at(vars(PERWT, HHWT), as.numeric) %>% 
	mutate_at(vars(HHINCOME, OWNCOST, RENTGRS, OCC), as.integer) %>% 
	janitor::clean_names() %>% 
	left_join(minc, by = "countyfip") %>% 
	mutate(ratio = hhincome / minc) %>% 
	mutate(
		inc_band = cut(
			ratio,
			breaks = c(-Inf, 0.3, 0.5, .8, 1.2, Inf),
			labels = c("Very low", "Low", "Mid-low", "Mid-high", "High"),
			include.lowest = T, right = T)) %>% 
	mutate(
		inc_band = as.factor(inc_band) %>%
			fct_relevel(., "Very low", "Low", "Mid-low", "Mid-high", "High")) %>% 
	mutate(cb = if_else(ownershp == "Rented", (rentgrs * 12) / hhincome, 99999)) %>% 
	mutate(cb = if_else(ownershp == "Owned or being bought (loan)", (owncost * 12) / hhincome, cb)) %>%
	# if housing cost is 0 and income is 0, no burden
	mutate(cb = if_else((rentgrs == 0 & hhincome == 0), 0, cb)) %>%
	mutate(cb = if_else((owncost == 0 & hhincome == 0), 0, cb)) %>%
	#if income is <=0 and housing cost is >0, burden
	mutate(cb = if_else((rentgrs > 0 & hhincome <= 0), 1, cb)) %>%
	mutate(cb = if_else((owncost > 0 & hhincome <= 0), 1, cb)) %>%
	# some people pay more than 100% income to housing, but I will code these as 1
	mutate(cb = if_else(cb > 1, 1, cb)) %>%
	mutate(
		cost_burden = cut(
			cb,
			breaks = c(-Inf, .3, .5, Inf),
			labels = c("No burden", "Cost-burdened", "Severely cost-burdened"),
			include.lowest = T, right = F)) %>% 
		mutate(race2 = if_else(hispan == "Not Hispanic", as.character(race), "Latino")) %>% 
	mutate(race2 = as.factor(race2) %>% 
				 	fct_recode(Black = "Black/African American/Negro") %>%
				 	fct_other(keep = c("White", "Black", "Latino"), other_level = "Other race") %>%
				 	fct_relevel("White", "Black", "Latino", "Other race"))

des <- pums %>%
	filter(pernum == "1", hhincome != 9999999, ownershp != "N/A") %>% 
	as_survey_design(., ids = 1, wt = hhwt)

out <- list()
```

```{r hh by inc band}
county_hhlds <- des %>%
	select(hhwt, name, inc_band) %>% 
	group_by(name, inc_band) %>% 
	summarise(value = survey_total(hhwt)) %>% 
	mutate(level = "2_counties")

county_total <- des %>%
	select(hhwt, name) %>% 
	group_by(name) %>% 
	summarise(value = survey_total(hhwt)) %>% 
	mutate(inc_band = "Total") %>% 
	mutate(level = "2_counties")

ct_hhlds <- des %>%
	select(hhwt, statefip, inc_band) %>% 
	group_by(statefip, inc_band) %>% 
	summarise(value = survey_total(hhwt)) %>% 
	mutate(name = "Connecticut", level = "1_state") %>% 
	select(-statefip)

ct_total <- des %>%
	select(hhwt, statefip) %>% 
	group_by(statefip) %>% 
	summarise(value = survey_total(hhwt)) %>% 
	mutate(name = "Connecticut", level = "1_state", inc_band = "Total") %>% 
	select(-statefip)

hh_by_inc_band <- bind_rows(county_hhlds, county_total, ct_hhlds, ct_total) %>%
	ungroup() %>%
	mutate(inc_band = as.factor(inc_band) %>% 
				 	fct_relevel(., "Very low", "Low", "Mid-low", "Mid-high", "High", "Total"),
				 level = as.factor(level)) %>% 
	arrange(level, name) %>% 
	group_by(level, name) %>% 
	calc_shares(group = inc_band, denom = "Total", value = value, moe = value_se)

out$hh_by_inc_band <- hh_by_inc_band
```

## Define income bands

Would it be preferable to set these as prettier breaks, or use the CT numbers for all counties?

**A better chart here would be color coded segments indicating each group's range, with each area on a new row. Could use arrow ends or something to communicate the top and bottom. Come back to this idea.**

```{r inc table}
ctminc <- get_acs(geography = "state", state = 09, table = "B19013") %>% 
	select(name = NAME, minc = estimate)

income_table <- minc %>% 
	bind_rows(ctminc) %>% 
	mutate(vl = comma(round(minc * .3, 0), accuracy = 1),
				 l = comma(round(minc * .5, 0), accuracy = 1),
				 ml = comma(round(minc * .8, 0), accuracy = 1), 
				 mh = comma(round(minc * 1.2, 0), accuracy = 1),
				 `Very low` = paste("Less than $", vl, sep = ""),
				 Low = paste("Between $", vl, " and $", l, sep = ""),
				 `Mid-low` = paste("Between $", l, " and $", ml, sep = ""),
				 `Mid-high` = paste("Between $", ml, " and $", mh, sep = ""),
				 High = paste("More than $", mh, sep = "")) %>% 
	select(Name = name, `Very low`:High)

kable(income_table, caption = "Income ranges by income band and area")
```

## Count/share of households by income band

Using the new breakdowns, high income households *vastly* outnumber lower income households.

FYI, each county was very consistent in its share of households in each income band. High income was more than 40% with the rest somewhere between 10% and 20%

```{r}
hh_by_inc_band %>% 
	filter(inc_band != "Total", name == "Connecticut") %>% 
	mutate(inc_band = fct_rev(inc_band)) %>% 
	ggplot(aes(value, inc_band)) +
	geom_col(aes(fill = inc_band), width = .7, position = position_dodge(.8)) +
	scale_x_continuous(
		expand = expansion(mult = c(0, 0.1)),
		labels = scales::comma) +
	geom_text(aes(
		label = comma(value, accuracy = 1)),
		position = position_dodge(.8), hjust = 1, family = "Roboto Condensed", size = 4) +
	guides(fill = guide_legend(title = "")) +
	labs(
		x = "",
		y = "",
		title = "Number of households in each income band",
		subtitle = "Connecticut") +
	scale_fill_custom(rev = T) +
	theme(
		panel.grid.minor = element_blank(),
		panel.grid.major = element_blank(),
		legend.position = "none",
		plot.title.position = "plot",
		axis.text.x = element_blank(),
		axis.text.y = element_text(colour = "black"),
		strip.text.y = element_blank())
```

```{r}
kable(hh_by_inc_band %>% 
	mutate(level = fct_rev(level)) %>% 
	arrange(level) %>% 
	select(Name = name, inc_band, value) %>% 
	mutate(value = comma(value, accuracy = 1)) %>% 
	pivot_wider(id_cols = Name, names_from = "inc_band") %>% 
	select(Name, `Very low`:High, Total),
	caption = "Number of households by income band")
```

```{r, eval = F}
hh_by_inc_band %>% 
	filter(inc_band != "Total", name == "Connecticut") %>% 
	group_by(level) %>% 
	mutate(name = as.factor(name) %>% 
				 	fct_rev()) %>% 
	ggplot(aes(inc_band, value)) +
	geom_col(aes(fill = inc_band), width = .7, position = position_dodge(.75)) +
	geom_text(aes(label = percent(share, accuracy = 1)),
						position = position_dodge(.75), vjust = 1.2, family = "Roboto Condensed", size = 4) +
	scale_y_continuous(expand = expansion(mult = c(0, 0))) +
	scale_fill_custom() +
	guides(fill = guide_legend(title = "")) +
	labs(x = "", y = "",
			 title = "Share of households in each income band") +
	theme(panel.grid.major  = element_blank(),
				panel.grid.minor = element_blank(),
				axis.text.y = element_blank(),
				axis.text.x = element_text(colour = "black"),
				legend.position = "none",
				plot.title.position = "plot")
```

## Household characteristics by income bands

### Race breakdowns

```{r}
county_hhlds_by_race <- des %>%
	select(hhwt, name, inc_band, race2) %>% 
	group_by(name, inc_band, race2) %>% 
	summarise(value = survey_total(hhwt)) %>% 
	mutate(level = "2_counties")

county_race_total <- des %>%
	select(hhwt, name, race2) %>% 
	group_by(name, race2) %>% 
	summarise(value = survey_total(hhwt)) %>% 
	mutate(inc_band = "Total") %>% 
	mutate(level = "2_counties")

ct_hhlds_by_race <- des %>%
	select(hhwt, statefip, inc_band, race2) %>% 
	group_by(statefip, inc_band, race2) %>% 
	summarise(value = survey_total(hhwt)) %>% 
	mutate(name = "Connecticut", level = "1_state") %>% 
	select(-statefip)

ct_race_total <- des %>%
	select(hhwt, statefip, race2) %>% 
	group_by(statefip, race2) %>% 
	summarise(value = survey_total(hhwt)) %>% 
	mutate(name = "Connecticut", level = "1_state", inc_band = "Total") %>% 
	select(-statefip)

hh_by_race_inc_band <- bind_rows(county_hhlds_by_race, county_race_total, ct_hhlds_by_race, ct_race_total) %>%
	ungroup() %>%
	mutate(inc_band = as.factor(inc_band) %>% 
				 	fct_relevel(., "Very low", "Low", "Mid-low", "Mid-high", "High", "Total"),
				 level = as.factor(level)) %>% 
	arrange(level, name, race2) %>% 
	group_by(level, name, race2) %>% 
	calc_shares(group = inc_band, denom = "Total", value = value, moe = value_se)

out$hh_by_inc_band <- hh_by_race_inc_band
```

Considering race/ethnicity of head of household. Statewide, a quarter of all households headed by a Black or Latino person are very low income, earning less than 30% of the county household median income, compared to just over a tenth of households headed by a white person. Some variation exists by county. In the three largest counties, half of white households are high income.

```{r fig.width=10, fig.height=10}
hh_by_race_inc_band %>% 
	filter(inc_band != "Total") %>% 
	mutate(race2 = fct_rev(race2)) %>% 
	ggplot(aes(share, race2, group = race2)) +
	geom_col(aes(fill = inc_band), width = .8, position = position_stack(1)) +
	guides(fill = guide_legend(title = "", reverse = T)) +
	geom_text(aes(label = percent(share, accuracy = 1)),
						position = position_stack(.5), family = "Roboto Condensed") +
	scale_x_continuous(expand = expansion(mult = c(0, 0))) +
	facet_wrap(facets = "name") +
	guides(fill = guide_legend(title = "")) +
	scale_fill_custom() +
	labs(x = "", y = "",
			 title = "Share of households in each income band by race of HOH") +
	theme(panel.grid.major  = element_blank(),
				panel.grid.minor = element_blank(),
				axis.text.y = element_text(colour = "black"),
				axis.text.x = element_blank(),
				legend.position = "bottom",
				plot.title.position = "plot")
```

### Jobs held by household occupants

Retrieved a list of 2018 occ codes from the Census Bureau at
<https://www.census.gov/topics/employment/industry-occupation/guidance/code-lists.html>. 

This table lists the top five occupations, in order from the most numerous, for household inhabitants—so not just heads of household, but all household members, including inhabitants with no work experience in the past 5 years or who have never worked—by household income band by county.

To be honest, this is a little surprising in places. I expected more food service workers in general, and I'm surprised at how many elementary and middle school teachers are workers in higher income households. Either I have the exact wrong impression of how much teachers are paid or it's a common occupation for people whose partners/spouses pull in big money. And yet, #thestruggle: adjuncts and GAs in Tolland County (UConn) getting those minimum wage grad school stipends while profs in New Haven and Middlesex Counties make six figures teaching half the load.

**Mark brought up a good point about common occupations (like teachers, cashiers) present in each income band. If this is used in the report, it might be best to look at the output and cherry pick some representative occupations.**

```{r}
des2 <- pums %>%
	filter(hhincome != 9999999, ownershp != "N/A") %>% 
	as_survey_design(., ids = 1, wt = perwt)

occ_lut <- read_csv("../input_data/occ_codes.csv") %>% 
	mutate(occ_code = as.integer(occ_code)) #leading 0s

common_jobs_by_inc_band <- pums %>%
	select(perwt, name, inc_band, occ) %>% 
	group_by(name, inc_band, occ) %>% 
	summarise(workers = sum(perwt)) %>% 
	mutate(level = "2_counties") %>% 
	filter(occ != "0") %>% #0 is "n/a" occ
	group_by(name, inc_band) %>% 
	slice_max(workers, n = 10) %>%
	left_join(occ_lut, by = c("occ" = "occ_code")) %>% 
	select(level, name, inc_band, workers, occ, occ_label)

out$common_jobs_by_inc_band <- common_jobs_by_inc_band

common_jobs_by_inc_band %>% 
	group_by(level, name, inc_band) %>% 
	mutate(rank = order(workers, decreasing = T)) %>% 
	select(name, inc_band, rank, occ_label) %>% 
	pivot_wider(id_cols = c("name", "inc_band"), names_from = "rank", values_from = "occ_label") %>% 
	mutate(`Common occupations` = paste(`1`, `2`, `3`, `4`, `5`, sep = "; ")) %>% 
	select(Name = name, `Income band` = inc_band, `Common occupations`) %>% 
	pivot_wider(id_cols = Name, names_from = "Income band", values_from = "Common occupations") %>% 
	kable(caption = "Common occupations for workers by household income band")
```

## Cost burden by income band

```{r}
county_cb <- des %>%
	select(hhwt, name, inc_band, cost_burden) %>% 
	group_by(name, inc_band, cost_burden) %>% 
	summarise(value = survey_total(hhwt)) %>% 
	mutate(level = "2_counties")

ct_cb <- des %>%
	select(hhwt, statefip, inc_band, cost_burden) %>%
	group_by(statefip, inc_band, cost_burden) %>%
	summarise(value = survey_total(hhwt)) %>%
	mutate(name = "Connecticut", level = "1_state") %>%
	select(-statefip)

cb_by_inc_band <- bind_rows(county_cb, county_hhlds, ct_cb, ct_hhlds) %>%
	mutate(cost_burden = if_else(is.na(cost_burden), "Total", as.character(cost_burden)),
				 cost_burden = as.factor(cost_burden) %>% 
				 	fct_relevel(., "No burden", "Cost-burdened", "Severely cost-burdened", "Total")) %>% 
	ungroup() %>%
	mutate(inc_band = as.factor(inc_band) %>%
				 	fct_relevel(., "Very low", "Low", "Mid-low", "Mid-high", "High"),
				 level = as.factor(level)) %>%
	arrange(level, name, inc_band) %>%
	group_by(level, name, inc_band) %>%
	calc_shares(group = cost_burden, denom = "Total", value = value, moe = value_se)

out$cb_by_inc_band <- cb_by_inc_band
```

Real quick top level summary of cost burden before we get into the details.

```{r fig.height=4}
cb_by_inc_band %>% 
	ungroup() %>% 
	select(level, name, cost_burden, value) %>% 
	group_by(level, name, cost_burden) %>% 
	summarise(value = sum(value)) %>% 
	ungroup() %>% 
	group_by(level, name) %>% 
	calc_shares(group = cost_burden, denom = "Total", value = value) %>% 
	filter(!is.na(share)) %>% 
	ungroup() %>% 
	group_by(level) %>% 
	mutate(name = fct_rev(name)) %>% 
	ggplot(aes(share, name, group = cost_burden)) +
	geom_col(aes(fill = cost_burden), width = .75, position = position_stack(.5)) +
	geom_text(aes(label = percent(share, accuracy = 1)), position = position_stack(.5), family = "Roboto Condensed", size = 3.5) +
	scale_x_continuous(expand = expansion(mult = c(0, 0))) +
	scale_fill_manual(values = c("grey80", pal[1], pal[4])) +
	theme(legend.position = "bottom",
				plot.title.position = "plot", 
				axis.text.x = element_blank(),
				axis.text.y = element_text(colour = "black"),
				panel.grid.major = element_blank(),
				panel.grid.minor = element_blank()) +
	guides(fill = guide_legend(title = "", reverse = T)) +
	labs(title = "Cost burden severity",
			 x = "", y = "", caption = "Cost burdened: 30-50% household income to housing costs.\nSeverely cost burdened: More than 50% of household income to housing costs.")
```

No surprise that cost burden rates among very low income households are more than 80%. At the statewide level that's more than 14x the rate of high income households.

```{r fig.width=8}
cb_by_inc_band %>% 
	mutate(cost_burden = fct_collapse(cost_burden, Burden = c("Cost-burdened", "Severely cost-burdened"))) %>% 
	ungroup() %>% 
	select(-share, -sharemoe, -value_se) %>% 
	group_by(level, name, inc_band, cost_burden) %>% 
	summarise(value = sum(value)) %>% 
	ungroup() %>% 
	group_by(level, name, inc_band) %>% 
	calc_shares(group = cost_burden, denom = "Total", value = value) %>% 
	filter(cost_burden == "Burden") %>% 
	group_by(level) %>% 
	mutate(name = as.factor(name) %>% 
				 	fct_rev()) %>% 
	ggplot(aes(share, name, group = inc_band)) +
	geom_point(aes(color = inc_band), size = 7.5, alpha = .8) +
	geom_text(aes(
		label = percent(share, accuracy = 1)),
		family = "Roboto Condensed", size = 3.55) +
	scale_x_continuous(expand = expansion(mult = c(.025, .1))) +
	guides(color = guide_legend(title = "")) +
	labs(
		x = "",
		y = "",
		title = "Cost-burden rates for households in each income band") +
	scale_color_custom() +
	theme(
		panel.grid.minor = element_blank(),
		panel.grid.major.x = element_blank(),
		legend.position = "bottom",
		plot.title.position = "plot",
		axis.text.x = element_blank(),
		axis.text.y = element_text(colour = "black"))
```

Breaking this down by regular and severe cost burden (although I don't think we should do this in the report!) in Fairfield and New Haven Counties, about the same share of low income households are cost burdened or severely cost burdened. Two-thirds or more very low income households are severely cost burdened.

**Note, these would add up to 100% if households with no burden were included, so the chart is read as "16% of very low income households in Connecticut are cost burdened and another 70% are severely cost burdened."**

```{r fig.height=8, fig.width=8}
cb_by_inc_band %>% 
	ungroup() %>% 
	filter(!cost_burden %in% c("Total", "No burden")) %>% 
	group_by(level) %>% 
	mutate(name = as.factor(name) %>% 
				 	fct_rev()) %>% 
	ggplot(aes(share, name, group = inc_band)) +
	geom_point(aes(color = inc_band), size = 6.5, alpha = 0.8) +
	geom_text(aes(
		label = percent(share, accuracy = 1)),
		family = "Roboto Condensed", size = 2.75, alpha = 0.8) +
	scale_x_continuous(expand = expansion(mult = c(.025, .1))) +
	facet_grid(rows = "cost_burden", scales = "free", space = "fixed") +
	guides(color = guide_legend(title = "")) +
	labs(
		x = "",
		y = "",
		title = "Rates of burden by burden type for households in each income band",
		caption = "Cost-burdened: spending 30%-50% of household income on housing;\nSeverely cost-burdened: spending more than 50% of household income on housing.") +
	scale_color_custom() +
	theme(
		panel.grid.minor = element_blank(),
		panel.grid.major.x = element_blank(),
		legend.position = "bottom",
		plot.title.position = "plot",
		axis.text.x = element_blank(),
		axis.text.y = element_text(colour = "black"))
```

Quick diversion: is the SCB rate among very low income households partially explained by some of these households having housing costs and no/negative negative income?

By definition, the household is in the "very low income" income band if household income is $0 or less because that's less than 30% CMI. There are about 15K poor households with no or negative income and some nonzero housing cost, making them "severely cost burdened" by definition. These ~15K units make up about 7% of all very low income households, which is not insignificant, but it's not the sole motivator for high SCB rates in this income band.

```{r}
des %>%
	mutate(income = if_else(hhincome == 0, "no_income", "positive_income")) %>% 
	mutate(income = if_else(hhincome < 0, "negative_income", income)) %>% 
	select(hhwt, income, cost_burden) %>% 
	group_by(income, cost_burden) %>% 
	filter(income != "positive_income", cost_burden == "Severely cost-burdened") %>% 
	summarise(households = survey_total(hhwt))
```
## Average housing-cost-to-income ratio for each band

```{r}
avg_cost_ratio_county <- pums %>%
	filter(pernum == "1", hhincome != 9999999, ownershp != "N/A") %>%
	select(hhwt, name, inc_band, cb) %>%
	mutate(mult = cb * hhwt) %>% 
	group_by(name, inc_band) %>% 
	summarise(wm_cb = sum(mult)/sum(hhwt)) %>% 
	mutate(level = "2_counties")

avg_cost_ratio_ct <- pums %>%
	filter(pernum == "1", hhincome != 9999999, ownershp != "N/A") %>%
	select(hhwt, inc_band, cb) %>%
	mutate(mult = cb * hhwt) %>% 
	group_by(inc_band) %>% 
	summarise(wm_cb = sum(mult)/sum(hhwt)) %>% 
	mutate(name = "Connecticut", level = "1_state")

avg_cost_ratio_inc_band <- bind_rows(avg_cost_ratio_county, avg_cost_ratio_ct)

out$avg_cost_ratio_inc_band <- avg_cost_ratio_inc_band
```

Urban's DC study found that higher income households paid about 12% income to housing. In CT it's about 16%. For a household with $200K in income, that's about $2667/month in housing costs, which I just don't think is that high considering there are some kinda crappy 2BRs in East Rock that go for that much.

For a household at the lower end of CT's affluent band, earning about $114K, 16% of income to housing cost would be about $1520, which as a renter strikes me as unbelievably low for someone of those means. It's the same as 30% for someone earning $60K. Why is that OK?

**7/15:** Talked with the team and I think we're going to use 30% for all income bands rather than the sliding scale.

```{r}
avg_cost_ratio_inc_band %>% 
	group_by(level) %>% 
	mutate(name = as.factor(name) %>% 
				 	fct_rev()) %>% 
	mutate(wm_cb = round(wm_cb, 3)) %>% 
	ggplot(aes(wm_cb, name, group = inc_band)) +
	geom_point(aes(color = inc_band), size = 6.5, alpha = 0.8) +
	geom_vline(xintercept = .3, color = "gray60", size = 0.5, linetype = "23") +
	geom_vline(xintercept = .5, color = "gray60", size = 0.5, linetype = "23") +
	geom_text(aes(
		label = percent(wm_cb, accuracy = 1)),
		family = "Roboto Condensed", size = 2.75, alpha = 0.8) +
	scale_x_continuous(breaks = c(.3, .5),
										 labels = c("Cost burden", "Severe cost burden"),
										 expand = expansion(mult = c(.025, .1))) +
	guides(color = guide_legend(title = "")) +
	labs(
		x = "",
		y = "",
		title = str_wrap("Average housing-cost-to-income-ratio by income band", 60),
		caption = "Weighted mean of cost ratio to IPUMS household weight") +
	scale_color_custom() +
	theme(
		panel.grid.minor = element_blank(),
		panel.grid.major.x = element_blank(),
		legend.position = "bottom",
		plot.title.position = "plot",
		axis.text.x = element_text(colour = "black"),
		axis.text.y = element_text(colour = "black"))
```

One last thing real quick... what's the average *actual* housing cost for each band?

```{r}
cost_county_owners <- pums %>%
	filter(pernum == "1", hhincome != 9999999, ownershp == "Owned or being bought (loan)") %>%
	select(hhwt, name, inc_band, hcost = owncost)

cost_county_renters <- pums %>%
	filter(pernum == "1", hhincome != 9999999, ownershp == "Rented") %>%
	select(hhwt, name, inc_band, hcost = rentgrs)

cost_ct_owners <- pums %>%
  filter(pernum == "1", hhincome != 9999999, ownershp == "Owned or being bought (loan)") %>%
	mutate(name = "Connecticut") %>% 
	select(hhwt, name, inc_band, hcost = owncost)

cost_ct_renters <- pums %>%
	filter(pernum == "1", hhincome != 9999999, ownershp == "Rented") %>%
	mutate(name = "Connecticut") %>% 
	select(hhwt, name, inc_band, hcost = rentgrs)

avg_cost_inc_band <- bind_rows(cost_county_owners, cost_county_renters, cost_ct_owners, cost_ct_renters) %>% 
	mutate(mult = hcost * hhwt) %>% 
	group_by(name, inc_band) %>% 
	summarise(wm_cost = sum(mult)/sum(hhwt)) %>% 
	mutate(level = if_else(name == "Connecticut", "1_state", "2_counties"))

out$avg_cost_inc_band <- avg_cost_inc_band
```

```{r, eval=F}
#want to combine own and rent
avg_cost_county_owners <- pums %>%
	filter(pernum == "1", hhincome != 9999999, ownershp == "Owned or being bought (loan)") %>%
	select(hhwt, name, inc_band, owncost) %>%
	mutate(mult = owncost * hhwt) %>% 
	group_by(name, inc_band) %>% 
	summarise(wm_cost = sum(mult)/sum(hhwt)) %>% 
	mutate(tenure = "owner", level = "2_counties")

avg_cost_county_renters <- pums %>%
	filter(pernum == "1", hhincome != 9999999, ownershp == "Rented") %>%
	select(hhwt, name, inc_band, rentgrs) %>%
	mutate(mult = rentgrs * hhwt) %>% 
	group_by(name, inc_band) %>% 
	summarise(wm_cost = sum(mult)/sum(hhwt)) %>% 
	mutate(tenure = "renter", level = "2_counties")

avg_cost_ct_owners <- pums %>%
  filter(pernum == "1", hhincome != 9999999, ownershp == "Owned or being bought (loan)") %>%
	select(hhwt, inc_band, owncost) %>%
	mutate(mult = owncost * hhwt) %>% 
	group_by(inc_band) %>% 
	summarise(wm_cost = sum(mult)/sum(hhwt)) %>% 
	mutate(tenure = "owner", name = "Connecticut", level = "1_state")

avg_cost_ct_renters <- pums %>%
	filter(pernum == "1", hhincome != 9999999, ownershp == "Rented") %>%
	select(hhwt, inc_band, rentgrs) %>%
	mutate(mult = rentgrs * hhwt) %>% 
	group_by(inc_band) %>% 
	summarise(wm_cost = sum(mult)/sum(hhwt)) %>% 
	mutate(tenure = "renter", name = "Connecticut", level = "1_state")

avg_cost_inc_band <- bind_rows(avg_cost_county_renters, avg_cost_county_owners, avg_cost_ct_renters, avg_cost_ct_owners)

out$avg_cost_inc_band <- avg_cost_inc_band
```

```{r fig.height=5}
avg_cost_inc_band %>% 
	group_by(level) %>% 
	mutate(name = as.factor(name) %>% 
				 	fct_rev()) %>% 
	mutate(wm_cost = round(wm_cost/1000, 1)) %>% 
	ggplot(aes(wm_cost, name, group = inc_band)) +
	geom_point(aes(color = inc_band), size = 6.5, alpha = 0.8) +
	geom_text(aes(
		label = dollar(wm_cost, accuracy = .1)),
		family = "Roboto Condensed", size = 3, alpha = 0.8) +
	scale_x_continuous(expand = expansion(mult = c(.025, .025))) +
	guides(color = guide_legend(title = "")) +
	labs(
		x = "Monthly housing cost (thousands)",
		y = "",
		title = str_wrap("Average actual housing costs by income band", 60)) +
	scale_color_custom() +
	theme(
		panel.grid.minor = element_blank(),
		panel.grid.major.x = element_blank(),
		legend.position = "bottom",
		plot.title.position = "plot",
		axis.text.x = element_blank(),
		axis.text.y = element_text(colour = "black"))
```

```{r}
housing_cost_gap <- pums %>%
	filter(cost_burden != "No burden") %>% 
	mutate(affordable_hcost = hhincome / 12 * .3) %>% 
	mutate(affordable_cost = if_else(affordable_hcost < 0, 0, affordable_hcost)) %>% 
	mutate(actual_hcost = if_else(ownershp == "Rented", rentgrs, NULL)) %>% 
	mutate(actual_hcost = if_else(ownershp == "Owned or being bought (loan)", owncost, actual_hcost)) %>% 
	filter(actual_hcost != 999999) %>% 
	mutate(diff = actual_hcost - affordable_hcost) %>%  
	filter(diff != 0) %>% #excluding no income/no housing cost households
	mutate(mult = hhwt * diff,
				 name = as.factor(name)) %>% 
	select(name, inc_band, mult, hhwt) %>% 
	group_by(name, inc_band) %>% 
	summarise(monthly_affordability_gap = sum(mult)/sum(hhwt))
```

Here, I looked only at households whose housing costs exceed 30% of income, and took the weighted average of the gap between what they actually pay for housing versus what they should pay at an affordable (30%) threshold. Very low and high income households spend the most over the affordable threshold. The average gap for households in all income bands in FC is over $800/month while in most other counties the gap falls between $400 and $800/month.

```{r}
housing_cost_gap %>% 
	mutate(name = fct_rev(name)) %>% 
	ggplot(aes(monthly_affordability_gap, name, group = name)) +
	geom_point(aes(color = inc_band), size = 2.5, alpha = .8) +
	scale_color_custom() +
	scale_x_continuous(breaks = c(400, 800, 1200),
										 expand = expansion(mult = c(.1, .1)),
										 labels = dollar_format()) +
	guides(color = guide_legend(title = "")) +
	labs(title = str_wrap("Average monthly affordability gap by income band for households that are cost-burdened", 60),
			 subtitle = "Dollars spent over affordable amount (30% of household's income) ",
			 x = "", y = "") +
theme(plot.title.position = "plot",
			axis.text.y = element_text(colour = "black", size = 11),
			axis.text.x = element_text(colour = "black", size = 11),
			legend.position = "right")
```

## Affordable housing costs to households in each band

Some future iteration of this notebook should find a way to combine this table with the actual housing costs chart above, but the topline is that the average actual costs in low and very low income households exceeds the affordable threshold (except low income households in Windham County). The middle-to-high income households' average actual housing cost is within the affordable range.

```{r}
affordable_cost_table <- minc %>% 
	bind_rows(ctminc) %>% 
	select(-countyfip) %>% 
	mutate(vl = minc * .3,
				 l = minc * .5,
				 ml = minc * .8, 
				 mh = minc * 1.2) %>% 
	select(-minc) %>% 
	pivot_longer(cols = vl:mh, names_to = "inc_band", values_to = "income") %>% 
	mutate(income = round(income, 0),
				 affordable_hcost = round(income / 12 * .3, 0)) %>% 
	select(name, inc_band, affordable_hcost) %>% 
	mutate(affordable_hcost = comma(affordable_hcost, accuracy = 1)) %>% 
	pivot_wider(id_cols = name, names_from = inc_band, values_from = affordable_hcost) %>% 
	mutate(`Very low` = paste("Less than $", vl, sep = ""),
				 Low = paste("Between $", vl, " and $", l, sep = ""),
				 `Mid-low` = paste("Between $", l, " and $", ml, sep = ""),
				 `Mid-high` = paste("Between $", ml, " and $", mh, sep = ""),
				 High = paste("More than $", mh, sep = ""))

kable(affordable_cost_table %>% 
				select(Name = name, `Very low`:High),
			caption = "Affordable monthly housing cost ranges by income band and area")
```

## What income band do households live in, what cost band do they pay in?

```{r}
owners <- pums %>%
	filter(pernum == "1", hhincome != 9999999, ownershp == "Owned or being bought (loan)") %>%
	select(hhwt, name, minc, inc_band, hcost = owncost)

renters <- pums %>%
	filter(pernum == "1", hhincome != 9999999, ownershp == "Rented") %>%
	select(hhwt, name, minc, inc_band, hcost = rentgrs)

units <- bind_rows(owners, renters) %>% 
	mutate(cost_band = NULL) %>%
	group_by(name) %>% 
	mutate(cost_band = if_else(between(hcost, 0, (minc * .3 / 12 * .3)), "Very low", "High")) %>% 
	mutate(cost_band = if_else(between(hcost, ((minc * .3 / 12 * .3) + 1), (minc * .5 / 12 * .3)), "Low", cost_band)) %>% 
	mutate(cost_band = if_else(between(hcost, ((minc * .5 / 12 * .3) + 1), (minc * .8 / 12 * .3)), "Mid-low", cost_band)) %>% 
	mutate(cost_band = if_else(between(hcost, ((minc * .8 / 12 * .3) + 1), (minc * 1.2 / 12 * .3)), "Mid-high", cost_band))

out$all_units_inc_and_cost_bands <- units	

codes <- tibble(
	code = seq(1:5),
	band = c("Very low", "Low", "Mid-low", "Mid-high", "High"))

units_by_income <- units %>% 
	select(name, hhwt, inc_band) %>% 
	group_by(name, inc_band) %>% 
	summarise(households = sum(hhwt))

county_units_by_cost_income <- units %>% 
	select(name, hhwt, inc_band = cost_band) %>% 
	group_by(name, inc_band) %>% 
	summarise(units = sum(hhwt)) %>% 
	left_join(units_by_income, by = c("name", "inc_band")) %>% 
	pivot_longer(cols = c("households", "units"), names_to = "group")

ct_units_by_cost_income <- county_units_by_cost_income %>% 
	ungroup() %>% 
	mutate(name = "Connecticut") %>% 
	group_by(name, inc_band, group) %>% 
	summarise(value = sum(value))

units_by_cost_income <- bind_rows(county_units_by_cost_income, ct_units_by_cost_income) %>% 
	mutate(level = if_else(name == "Connecticut", "1_state", "2_counties"))
```

```{r fig.height=9, fig.width=9, eval = F}
units_by_cost_income %>% 
	mutate(group = as.factor(group) %>% 
				 	fct_relevel(., "units", "households")) %>% 
	mutate(inc_band = as.factor(inc_band) %>% 
				 	fct_relevel(., "Very low", "Low", "Mid-low", "Mid-high", "High")) %>% 
	ggplot(aes(inc_band, value, group = group)) +
	geom_col(aes(fill = group), width = .8, position = position_dodge(.85)) +
	geom_text(aes(label = comma(value, accuracy = 1)), position = position_dodge(.85), vjust = "top", family = "Roboto Condensed", size = 3.5, fontface = "bold") +
	facet_grid(rows = vars(name), scales = "free", space = "fixed", switch = "y") +
	scale_fill_manual(values = c(pal[1], pal[3])) +
	guides(fill = guide_legend(title = "")) +
	theme(legend.position = "bottom",
				plot.title.position = "plot",
				panel.grid.minor = element_blank(),
				panel.grid.major = element_blank(),
				axis.text.y = element_blank(),
				axis.text.x = element_text(colour = "black", size = 11),
				strip.text.y.left = element_text(color = "black", size = 8, angle = 360)) +
	labs(title = "Counts of households and units by band",
			 x = "", y = "", caption = "Does not include vacant units")
```

There are many more higher income households than units in that cost band, so high income households have to occupy housing affordable to lower-income households. Likewise, the same holds at the other extreme: there are many more very low income households than very low income units and they have to occupy more expensive housing than they can afford.

Knowing that households paying into a cost band are a subset of households across many income bands, here's a heat map of households by income band and the cost band they pay into. Add each row and you'll get the total number of households in each income band. Add each column and you'll get the total of all households in each cost band.

There are a couple caveats... people who own their homes outright and just have some utility costs are usually in the very low cost band but may be in any income band. There are also a fair amount of people who are high income but have $0 cash rents (I guess their company or someone else pays their rent?) who would be in the very low cost band.

```{r eval = F}
relative_housing_costs <- units %>%
	ungroup() %>%
	left_join(codes, by = c("inc_band" = "band")) %>%
	rename(inc_code = code) %>%
	left_join(codes, by = c("cost_band" = "band")) %>%
	rename(cost_code = code) %>%
	mutate(cost_paid = if_else(inc_code == cost_code, "same", "higher")) %>%
	mutate(cost_paid = if_else(inc_code > cost_code, "lower", cost_paid)) %>%
	select(hhwt, name, inc_band, cost_paid) %>%
	mutate(inc_band = as.factor(inc_band) %>% 
				 	fct_relevel(., "Very low", "Low", "Mid-low", "Mid-high", "High")) %>% 
	group_by(name, inc_band, cost_paid) %>%
	summarise(value = sum(hhwt))

ct_hhld_totals <- ct_hhlds %>% 
	mutate(cost_paid = "total") %>% 
	select(inc_band, cost_paid, value)

ct_relative <- relative_housing_costs %>% 
	select(-name) %>% 
	group_by(inc_band, cost_paid) %>% 
	summarise(value = sum(value)) %>%
	bind_rows(ct_hhld_totals) %>% 
	ungroup() %>%
	group_by(inc_band) %>% 
	calc_shares(group = cost_paid, denom = "total", value = value)

ct_relative %>% 
	filter(cost_paid != "total") %>% 
	mutate(cost_paid = as.factor(cost_paid) %>% 
				 	fct_rev()) %>% 
	mutate(inc_band = as.factor(inc_band) %>% 
				 	fct_rev()) %>% 
	ggplot(aes(share, inc_band)) +
	geom_col(aes(fill = cost_paid), width = .75, position = position_stack()) +
	geom_text(aes(label = percent(share, accuracy = 1)), position = position_stack(.5), family = "Roboto Condensed") +
	scale_x_continuous(expand = expansion(mult = c(0, 0))) +
	scale_fill_custom() +
	labs(title = str_wrap("Share of households paying into the same, lower, or higher cost bands than their income band", 60), subtitle = "Connecticut", x = "", y = "") +
	theme(plot.title.position = "plot",
				axis.text.y = element_text(colour = "black"),
				axis.text.x = element_blank(),
				panel.grid.major = element_blank(),
				panel.grid.minor = element_blank())
```

```{r fig.width=6, fig.height=6}
income_vs_cost_bands <- units %>%
	select(-minc, -hcost, -name) %>%
	group_by(inc_band, cost_band) %>%
	summarise(units = sum(hhwt)) %>%
	mutate(inc_band = as.factor(inc_band) %>%
				 	fct_relevel(., "Very low", "Low", "Mid-low", "Mid-high", "High")) %>%
	mutate(cost_band = as.factor(cost_band) %>%
				 	fct_relevel(., "Very low", "Low", "Mid-low", "Mid-high", "High"))

income_vs_cost_bands %>% 
	mutate(inc_band = fct_rev(inc_band)) %>% 
	ggplot(aes(cost_band, inc_band, fill = units)) +
	geom_tile(show.legend = F) +
	geom_text(aes(label = comma(units)), family = "Roboto Condensed") +
	scale_x_discrete(position = "top",
									 expand = expansion(mult = c(0,0))) +
	scale_y_discrete(expand = expansion(mult = c(0,0))) +
	scale_fill_gradient(low = pal[3], high = pal[5]) +
	labs(title = "Households by income and cost bands",
			 subtitle = "Connecticut",
			 y = "Count of households in this income band...\n",
			 x = "... whose housing unit is in this cost band.\n") +
	theme(plot.title.position = "plot",
				axis.text.x = element_text(colour = "black"),
				axis.text.y = element_text(colour = "black"),
				axis.title.y = element_text(angle = 90, hjust = 0))
```

## How many housing units are in each cost bands

Establishing that there's a need for housing in lower cost bands, how many units exist in each band? This adds vacants to the occupied units above.

```{r}
hddi <- read_ipums_ddi("../input_data/usa_00040.xml")

cost_bands <- minc %>% 
	bind_rows(ctminc) %>% 
	select(-countyfip) %>% 
	mutate(vl = round((minc * .3 / 12 * .3), 0),
				 l = round((minc * .5 / 12 * .3), 0),
				 ml = round((minc * .8 / 12 * .3), 0), 
				 mh = round((minc * 1.2 / 12 * .3), 0)) %>% 
	select(-minc)

hpums <- read_ipums_micro(hddi, verbose = F) %>% 
	filter(RECTYPE == "H") %>% 
	mutate_at(vars(OWNERSHP, OWNERSHPD, VACANCY), as_factor) %>% 
	mutate_at(vars(OWNCOST, RENT, RENTGRS, VALUEH), as.numeric) %>% 
	janitor::clean_names() %>% 
	left_join(minc, by = "countyfip") %>% 
	left_join(cost_bands, by = "name") %>% 
	mutate(countyfip = as.character(countyfip))
	
occ_des <- hpums %>%
	filter(vacancy == "N/A", ownershp != "N/A") %>% 
	as_survey_design(., ids = 1, wt = hhwt)

own_occ_cost_bands <- occ_des %>%
	filter(owncost != 99999) %>% 
	select(hhwt, name, owncost, vl, l, ml, mh) %>% 
	group_by(name) %>% 
	mutate(tenure = "owner",
				 occupancy = "occupied",
				 very_low = between(owncost, 0, (vl - 1)),
				 low = between(owncost, vl, (l - 1)),
				 mid_low = between(owncost, l, (ml - 1)),
				 mid_high = between(owncost, ml, (mh - 1)),
				 high = between(owncost, mh, Inf)) %>% 
	ungroup() %>% 
	group_by(name, tenure, occupancy, very_low, low, mid_low, mid_high, high) %>% 
	summarise(units = survey_total(hhwt)) %>% 
	pivot_longer(cols = very_low:high, names_to = "cost_band") %>% 
	filter(value == T) %>% 
	select(name, tenure, occupancy, cost_band, units)

rent_occ_cost_bands <- occ_des %>%
	filter(owncost == 99999) %>% 
	select(hhwt, name, rentgrs, vl, l, ml, mh) %>% 
	group_by(name) %>% 
	mutate(tenure = "renter",
				 occupancy = "occupied",
				 very_low = between(rentgrs, 0, (vl - 1)),
				 low = between(rentgrs, vl, (l - 1)),
				 mid_low = between(rentgrs, l, (ml - 1)),
				 mid_high = between(rentgrs, ml, (mh - 1)),
				 high = between(rentgrs, mh, Inf)) %>% 
	ungroup() %>% 
	group_by(name, tenure, occupancy, very_low, low, mid_low, mid_high, high) %>% 
	summarise(units = survey_total(hhwt)) %>% 
	pivot_longer(cols = very_low:high, names_to = "cost_band") %>% 
	filter(value == T) %>% 
	select(name, tenure, occupancy, cost_band, units)

occ_cost_bands <- bind_rows(own_occ_cost_bands, rent_occ_cost_bands)
```

```{r}
#need to impute remaining utility, etc costs?
rent_vac_cost_bands <- hpums %>%
	filter(owncost == "99999", vacancy == "For rent or sale") %>% 
	select(hhwt, name, rent, vl, l, ml, mh) %>% 
	group_by(name) %>% 
	mutate(tenure = "renter",
				 occupancy = "vacant",
				 very_low = between(rent, 0, (vl - 1)),
				 low = between(rent, vl, (l - 1)),
				 mid_low = between(rent, l, (ml - 1)),
				 mid_high = between(rent, ml, (mh - 1)),
				 high = between(rent, mh, Inf)) %>% 
	ungroup() %>% 
	group_by(name, tenure,occupancy, very_low, low, mid_low, mid_high, high) %>% 
	summarise(units = sum(hhwt)) %>% 
	pivot_longer(cols = very_low:high, names_to = "cost_band") %>% 
	filter(value == T) %>% 
	select(name, tenure, occupancy, cost_band, units)
```

```{r}
avg_int_rates <- read_csv("../input_data/hmda_2019_lar.csv") %>% 
	select(countyfip = county_code, interest_rate) %>% 
	filter(!is.na(interest_rate), interest_rate != "Exempt", !is.na(countyfip)) %>%
	mutate(interest_rate = as.numeric(interest_rate), 
				countyfip = str_remove(countyfip, "090"),
				 countyfip = str_remove(countyfip, "^0+")) %>% 
	group_by(countyfip) %>% 
	summarise(avg_int_rate = round(mean(interest_rate) / 100, 4)) %>% 
	mutate(countyfip = as.character(countyfip))

median_mills <- read_csv("../input_data/mill_rates_2019.csv") %>% 
	left_join(town2county, by = c("name" = "town")) %>% 
	select(-name) %>% 
	left_join(minc, by = c("county" = "name")) %>% 
	select(countyfip, county, mill_rate) %>%
	group_by(countyfip, county) %>% 
	summarise(median_mill = median(mill_rate)) %>% 
  mutate(countyfip = as.character(countyfip))

pmi <- .007 #avg private mortgage insurance rate ~0.7%

#impute remaining utility costs
own_vac_cost_bands <- hpums %>%
	left_join(avg_int_rates, by = "countyfip") %>% 
	left_join(median_mills, by = "countyfip") %>% 
	filter(vacancy == "For sale only") %>% 
	mutate(loan = .9 * valueh, # 10% down
				 monthly_int = (avg_int_rate / 12), #annual rate divided across a year
				 monthly_pmt = loan * monthly_int * ((1+monthly_int)**360)/(((1+monthly_int)**360)-1), #principal and interest
				 mortgage_ins = pmi * loan / 12, #mortgage insurance at .7%
				 property_tax = valueh / 1000 * median_mill / 12,
				 total_monthly_pmt = round(monthly_pmt + mortgage_ins + property_tax, 0)) %>% 
	select(hhwt, name, total_monthly_pmt, vl, l, ml, mh) %>% 
	group_by(name) %>% 
	mutate(tenure = "owner",
				 occupancy = "vacant",
				 very_low = between(total_monthly_pmt, 0, (vl - 1)),
				 low = between(total_monthly_pmt, vl, (l - 1)),
				 mid_low = between(total_monthly_pmt, l, (ml - 1)),
				 mid_high = between(total_monthly_pmt, ml, (mh - 1)),
				 high = between(total_monthly_pmt, mh, Inf)) %>% 
	ungroup() %>% 
	group_by(name, tenure, occupancy, very_low, low, mid_low, mid_high, high) %>% 
	summarise(units = sum(hhwt)) %>% 
	pivot_longer(cols = very_low:high, names_to = "cost_band") %>% 
	filter(value == T) %>% 
	select(name, tenure, occupancy, cost_band, units)

vac_cost_bands <- bind_rows(rent_vac_cost_bands, own_vac_cost_bands)

units_by_tenure_occupancy_cost_band <- bind_rows(occ_cost_bands, vac_cost_bands) %>% 
	mutate(cost_band = as.factor(cost_band) %>% 
				 	fct_relevel(., "very_low", "low", "mid_low", "mid_high", "high")) %>% 
	mutate(occupancy = as.factor(occupancy) %>% 
				 	fct_relevel(., "occupied", "vacant"))

out$units_by_tenure_occupancy_cost_band <- units_by_tenure_occupancy_cost_band
```

This chart divides all housing units in CT into their cost bands and further by occupancy. Vacant, available are units listed as "For rent or sale" or "For sale only", while other vacant is all other vacancy categories ("For seasonal, recreational, or other occasional use", "For migrant farm workers", and  "Other vacant").


```{r}
units_by_tenure_occupancy_cost_band %>% 
	select(-tenure, -name) %>% 
	arrange(cost_band) %>% 
	group_by(occupancy, cost_band) %>% 
	summarise(units = sum(units)) %>% 
	ggplot(aes(cost_band, units, group = cost_band)) +
	geom_col(aes(fill = occupancy), position = position_stack()) +
	geom_text(aes(label = comma(units)), family = "Roboto Condensed", size = 3.5, position = position_stack(.5)) +
	scale_fill_manual(values = c(pal[1], pal[5]))
```

## Households who need housing in each cost band

To get a table of gaps and surpluses, I think I need to determine how many units are needed in each cost band (so, by default this will be the number of households in each income band if low income households should pay low income prices, right?), then count up the number of households whose costs are in each cost band and add the vacants by contract and mortgage costs. So how many households in each income band, vs. how many units in each cost band. Seems legit?

## Add homeless?
Not sure where to get good data... PIT counts by county? Mark suggests https://cceh.org/data/interactive/