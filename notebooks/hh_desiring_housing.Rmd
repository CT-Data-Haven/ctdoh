---
title: "Households desiring housing"
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = T, message = F, warning = F, echo = F)

set.seed(13)
```

```{r lib}
library(ipumsr)
library(tidyverse)
library(srvyr)
library(tidycensus)
library(hrbrthemes)
library(camiller)
library(scales)
library(kableExtra)
```

```{r source}
source("../_utils/town2county.R")
```

```{r gg etc}
theme_set(theme_ipsum_rc())

pal <- c("#92c9c5", "#ffe37e", "#ffac8f", "#cb94c4", "#5e63af")

scale_fill_custom <- function(palette = pal, rev = F) {
  if (rev) {
    scale_fill_manual(values = rev(pal))
  } else {
    scale_fill_manual(values = pal)
  }
}

scale_color_custom <- function(palette = pal, rev = F) {
  if (rev) {
    scale_color_manual(values = rev(pal))
  } else {
    scale_color_manual(values = pal)
  }
}
```

This analysis needs a better name. "Households desiring housing" to me suggests a household wants to move or is unhoused. Maybe just "households by income and affordable housing units" or something? Kind of a mouthful...

There's a lot going on in this notebook:

* Count and share of households by income band, and further:
    * households by income band by race
    * households by income band by presence of inhabitant with disability
* The kinds of occupations/jobs those household members work in
* Count and share of households in each band that are cost-burdened
* Average housing-cost-to-income ratio for each income band
* Average actual housing cost by cost band
* Approximate monthly housing cost range for an affordable unit (30%) for each income band (henceforth cost bands)
* Number of households in each income band versus what cost band they pay into
* Count and share of units by cost bands
* Vacant units in each cost band
* Number of housing units needed in each cost band so each household would have an affordable housing cost, vs. the actual count of units in those cost bands. In other words, total households by income band versus total units in each cost band.

## Establish groups

After discussion with team on 7/15 we will use median household income by county and the groupings below. I'm not committed to these names but needed a convenient shorthand for the analysis.

* Very low income: <= 0.3 CMI
* Low income: (0.3–0.5] CMI
* Mid-low income: (0.5–.8] CMI
* Mid-high income: (.8–1.2] CMI
* High income: (1.2–2.0] CMI

Cost-burden in predictable breaks:

* No burden: <30% income to housing
* Cost-burdened: [30%-50%) income to housing
* Severely cost-burdened: >=50% income to housing

And race/ethnicity into a few major categories so we can look at it by county:

* White (NH)
* Black (NH)
* Latino (any race)
* All others (grouped)

**Add flag for any inhabitant with a disability (should this be further pared down by type, e.g., ambulatory vs. sensory vs. other vs. none?)**

```{r pums prep}
minc <- get_acs(
  	geography = "county",
	  table = "B19013",
  	state = 09,
	  cache_table = T) %>% 
	arrange(GEOID) %>% 
	mutate(countyfip = seq(from = 1, to = 15, by = 2),
				 name = str_remove(NAME, ", Connecticut")) %>% 
	select(countyfip, name, minc = estimate)

ddi <- read_ipums_ddi("../input_data/usa_00043.xml")

pums <- read_ipums_micro(ddi, verbose = F)  %>% 
	mutate_at(vars(YEAR, PUMA, OWNERSHP, OWNERSHPD, RACE, RACED, HISPAN, HISPAND, DIFFREM, DIFFPHYS, DIFFMOB, DIFFCARE, DIFFEYE, DIFFHEAR), as_factor) %>% 
	mutate_at(vars(PERWT, HHWT), as.numeric) %>% 
	mutate_at(vars(HHINCOME, OWNCOST, RENTGRS, OCC), as.integer) %>% 
	janitor::clean_names() %>% 
	left_join(minc, by = "countyfip") %>% 
	mutate(ratio = hhincome / minc) %>% 
	mutate(
		inc_band = cut(
			ratio,
			breaks = c(-Inf, 0.3, 0.5, .8, 1.2, Inf),
			labels = c("Very low", "Low", "Mid-low", "Mid-high", "High"),
			include.lowest = T, right = T)) %>% 
	mutate(
		inc_band = as.factor(inc_band) %>%
			fct_relevel(., "Very low", "Low", "Mid-low", "Mid-high", "High")) %>% 
	mutate(cb = if_else(ownershp == "Rented", (rentgrs * 12) / hhincome, 99999)) %>% 
	mutate(cb = if_else(ownershp == "Owned or being bought (loan)", (owncost * 12) / hhincome, cb)) %>%
	# if housing cost is 0 and income is 0, no burden
	mutate(cb = if_else((rentgrs == 0 & hhincome == 0), 0, cb)) %>%
	mutate(cb = if_else((owncost == 0 & hhincome == 0), 0, cb)) %>%
	#if income is <=0 and housing cost is >0, burden
	mutate(cb = if_else((rentgrs > 0 & hhincome <= 0), 1, cb)) %>%
	mutate(cb = if_else((owncost > 0 & hhincome <= 0), 1, cb)) %>%
	# some people pay more than 100% income to housing, but I will code these as 1
	mutate(cb = if_else(cb > 1, 1, cb)) %>%
	mutate(
		cost_burden = cut(
			cb,
			breaks = c(-Inf, .3, .5, Inf),
			labels = c("No burden", "Cost-burdened", "Severely cost-burdened"),
			include.lowest = T, right = F)) %>% 
		mutate(race2 = if_else(hispan == "Not Hispanic", as.character(race), "Latino")) %>% 
	mutate(race2 = as.factor(race2) %>% 
				 	fct_recode(Black = "Black/African American/Negro") %>%
				 	fct_other(keep = c("White", "Black", "Latino"), other_level = "Other race") %>%
				 	fct_relevel("White", "Black", "Latino", "Other race"))

#logical flag for any disability
pums$has_disability <- apply(pums, 1, function(x) any(grep("Has|Yes", x)))

des <- pums %>%
	filter(pernum == "1", hhincome != 9999999, ownershp != "N/A") %>% 
	as_survey_design(., ids = 1, wt = hhwt)

out <- list()
```

```{r hh by inc band}
county_hhlds <- des %>%
	select(hhwt, name, inc_band) %>% 
	group_by(name, inc_band) %>% 
	summarise(value = survey_total(hhwt)) %>% 
	mutate(level = "2_counties")

county_total <- des %>%
	select(hhwt, name) %>% 
	group_by(name) %>% 
	summarise(value = survey_total(hhwt)) %>% 
	mutate(inc_band = "Total") %>% 
	mutate(level = "2_counties")

ct_hhlds <- des %>%
	select(hhwt, statefip, inc_band) %>% 
	group_by(statefip, inc_band) %>% 
	summarise(value = survey_total(hhwt)) %>% 
	mutate(name = "Connecticut", level = "1_state") %>% 
	select(-statefip)

ct_total <- des %>%
	select(hhwt, statefip) %>% 
	group_by(statefip) %>% 
	summarise(value = survey_total(hhwt)) %>% 
	mutate(name = "Connecticut", level = "1_state", inc_band = "Total") %>% 
	select(-statefip)

hh_by_inc_band <- bind_rows(county_hhlds, county_total, ct_hhlds, ct_total) %>%
	ungroup() %>%
	mutate(inc_band = as.factor(inc_band) %>% 
				 	fct_relevel(., "Very low", "Low", "Mid-low", "Mid-high", "High", "Total"),
				 level = as.factor(level)) %>% 
	arrange(level, name) %>% 
	group_by(level, name) %>% 
	calc_shares(group = inc_band, denom = "Total", value = value, moe = value_se)

out$hh_by_inc_band <- hh_by_inc_band
```

## Define income bands

Would it be better to use pretty breaks or the same breaks for all counties? I'm leaving it as-is, assuming we will put just CT in the main report text but include counties in the appendix.

```{r inc table}
#A better chart here would be color coded segments indicating each group's range, with each area on a new row.

ctminc <- get_acs(geography = "state", state = 09, table = "B19013") %>% 
	select(name = NAME, minc = estimate)

income_table <- minc %>% 
	bind_rows(ctminc) %>% 
	mutate(vl = comma(round(minc * .3, 0), accuracy = 1),
				 l = comma(round(minc * .5, 0), accuracy = 1),
				 ml = comma(round(minc * .8, 0), accuracy = 1), 
				 mh = comma(round(minc * 1.2, 0), accuracy = 1),
				 `Very low` = paste("Less than $", vl, sep = ""),
				 Low = paste("Between $", vl, " and $", l, sep = ""),
				 `Mid-low` = paste("Between $", l, " and $", ml, sep = ""),
				 `Mid-high` = paste("Between $", ml, " and $", mh, sep = ""),
				 High = paste("More than $", mh, sep = "")) %>% 
	select(Name = name, `Very low`:High)

kable(income_table, caption = "Income ranges by income band and area")
```

## Count/share of households by income band

Because the groupings are granular only at the lower income extreme, High income households *vastly* outnumber lower income households.

FYI, I did look at this by county, and each was very consistent in it distribution. High income was more than 40% with the rest somewhere between 10% and 20%. See table below.

```{r hh by inc band bar chart}
hh_by_inc_band %>% 
	filter(inc_band != "Total", name == "Connecticut") %>% 
	mutate(inc_band = fct_rev(inc_band)) %>% 
	ggplot(aes(value, inc_band)) +
	geom_col(aes(fill = inc_band), width = .7, position = position_dodge(.8)) +
	scale_x_continuous(
		expand = expansion(mult = c(0, 0.1)),
		labels = scales::comma) +
	geom_text(aes(
		label = comma(value, accuracy = 1)),
		position = position_dodge(.8), hjust = 1, family = "Roboto Condensed", size = 4) +
	guides(fill = guide_legend(title = "")) +
	labs(
		x = "",
		y = "",
		title = "Number of households in each income band",
		subtitle = "Connecticut") +
	scale_fill_custom(rev = T) +
	theme(
		panel.grid.minor = element_blank(),
		panel.grid.major = element_blank(),
		legend.position = "none",
		plot.title.position = "plot",
		axis.text.x = element_blank(),
		axis.text.y = element_text(colour = "black"),
		strip.text.y = element_blank())
```

```{r hh by inc band table}
kable(hh_by_inc_band %>% 
	mutate(level = fct_rev(level)) %>% 
	arrange(level) %>% 
	select(Name = name, inc_band, value) %>% 
	mutate(value = comma(value, accuracy = 1)) %>% 
	pivot_wider(id_cols = Name, names_from = "inc_band") %>% 
	select(Name, `Very low`:High, Total),
	caption = "Number of households by income band")
```

## Household characteristics by income bands

### Race breakdowns

```{r hh by inc band by race}
county_hhlds_by_race <- des %>%
	select(hhwt, name, inc_band, race2) %>% 
	group_by(name, inc_band, race2) %>% 
	summarise(value = survey_total(hhwt)) %>% 
	mutate(level = "2_counties")

county_race_total <- des %>%
	select(hhwt, name, race2) %>% 
	group_by(name, race2) %>% 
	summarise(value = survey_total(hhwt)) %>% 
	mutate(inc_band = "Total") %>% 
	mutate(level = "2_counties")

ct_hhlds_by_race <- des %>%
	select(hhwt, statefip, inc_band, race2) %>% 
	group_by(statefip, inc_band, race2) %>% 
	summarise(value = survey_total(hhwt)) %>% 
	mutate(name = "Connecticut", level = "1_state") %>% 
	select(-statefip)

ct_race_total <- des %>%
	select(hhwt, statefip, race2) %>% 
	group_by(statefip, race2) %>% 
	summarise(value = survey_total(hhwt)) %>% 
	mutate(name = "Connecticut", level = "1_state", inc_band = "Total") %>% 
	select(-statefip)

hh_by_race_inc_band <- bind_rows(county_hhlds_by_race, county_race_total, ct_hhlds_by_race, ct_race_total) %>%
	ungroup() %>%
	mutate(inc_band = as.factor(inc_band) %>% 
				 	fct_relevel(., "Very low", "Low", "Mid-low", "Mid-high", "High", "Total"),
				 level = as.factor(level)) %>% 
	arrange(level, name, race2) %>% 
	group_by(level, name, race2) %>% 
	calc_shares(group = inc_band, denom = "Total", value = value, moe = value_se)

out$hh_by_inc_band <- hh_by_race_inc_band
```

In the charts below, I'm considering race/ethnicity of head of household. Statewide, a quarter of all households headed by a Black or Latino person are very low income, earning less than 30% of the county household median income, compared to just over a tenth of households headed by a white person. Some variation exists by county. In the three largest counties, half of white households are high income.

**Other thoughts for later: Should pivot the data... share of race by income band rather than share of income band by race. We have lots of cost burden by race data elsewhere, could pull something in from HER. I hesitate to divide it up too much more than this, so more of an equity implication than an analysis crosstab.**

```{r hh by inc band by race bar charts, fig.width=10, fig.height=10}
hh_by_race_inc_band %>% 
	filter(inc_band != "Total") %>% 
	mutate(race2 = fct_rev(race2)) %>% 
	ggplot(aes(share, race2, group = race2)) +
	geom_col(aes(fill = inc_band), width = .8, position = position_stack(1)) +
	guides(fill = guide_legend(title = "", reverse = T)) +
	geom_text(aes(label = percent(share, accuracy = 1)),
						position = position_stack(.5), family = "Roboto Condensed") +
	scale_x_continuous(expand = expansion(mult = c(0, 0))) +
	facet_wrap(facets = "name") +
	guides(fill = guide_legend(title = "")) +
	scale_fill_custom() +
	labs(x = "", y = "",
			 title = "Share of households in each income band by race of HOH") +
	theme(panel.grid.major  = element_blank(),
				panel.grid.minor = element_blank(),
				axis.text.y = element_text(colour = "black"),
				axis.text.x = element_blank(),
				legend.position = "bottom",
				plot.title.position = "plot")
```

### Disability

Because of the sample size, I'm only looking at these households statewide, not by county.

I think there's still more to do here, but I want to wrap up some of the other tabulation I need to do and come back to it if time permits.

```{r}
hh_w_disability <- pums %>%
	filter(has_disability == T) %>% 
	select(cbserial) %>% 
	unique()

ct_inc_band_disability <- des %>% 
	mutate(disability = if_else(cbserial %in% hh_w_disability$cbserial, T, F)) %>% 
	select(hhwt, inc_band, disability) %>% 
	mutate(name = "Connecticut") %>% 
	group_by(name, inc_band, disability) %>% 
	summarise(value = survey_total(hhwt)) %>% 
	ungroup() %>% 
	group_by(name, inc_band)

ct_disability <- ct_inc_band_disability %>% 
	select(-value_se) %>% 
	mutate(inc_band = "Total") %>% 
	group_by(name, inc_band, disability) %>% 
	summarise(value = sum(value))

ct_inc_band_disability <- ct_inc_band_disability %>% 
	bind_rows(ct_disability)
```

Quick tabulations of households with an occupant with a disability
```{r}
kable(ct_inc_band_disability)
```

Taking a slightly different look than the table above, the plot below shows the share of households in each income band that have an occupant with a disability (so the numerator is households with an occupant with a disability in a given income band, and the denominator is all households in that income band).

While the High band has the most (by count) households with an occupant with a disability, it has the smallest share.

```{r}
ct_inc_band_disability %>%
	bind_rows(ct_hhlds) %>% 
	ungroup() %>% 
	select(-level) %>% 
	filter(inc_band != "Total") %>% 
	mutate(inc_band = as.factor(inc_band) %>% 
				 	fct_relevel(., "Very low", "Low", "Mid-low", "Mid-high", "High") %>% 
				 	fct_rev()) %>%
	mutate(disability = as.character(disability)) %>% 
	mutate(disability = if_else(is.na(disability), "Total", disability)) %>% 
	group_by(name, inc_band) %>% 
	calc_shares(group = disability, denom = "Total", value = value, moe = value_se) %>% 
	filter(disability == "TRUE", inc_band != "Total") %>% 
	ggplot(aes(share, inc_band, group = inc_band)) +
	geom_col(aes(fill = inc_band), position = position_dodge(1)) +
	geom_text(aes(label = percent(share, accuracy = 1)), position = position_dodge(1), family = "Roboto Condensed", size = 3.5, hjust = 1.1, vjust = .5) +
	scale_x_continuous(expand = expansion(mult = c(0, 0))) +
	scale_fill_custom(rev = T) +
	theme(plot.title.position = "plot",
				axis.text.x = element_blank(), 
				axis.text.y = element_text(colour = "black"),
				panel.grid.major = element_blank(),
				panel.grid.minor = element_blank(),
				legend.position = "none") +
	labs(title = str_wrap("Share of households with a person with a disability in each income band", 60),
			 subtitle = "Connecticut",
			 x = "", y = "")
```
Finally, what are the average cost burden rates for households with an occupant with a disability?

```{r}
ct_cost_ratio_inc_band_disability <- pums %>% 
	mutate(disability = if_else(cbserial %in% hh_w_disability$cbserial, T, F)) %>% 
	filter(pernum == "1", hhincome != 9999999, ownershp != "N/A") %>% 
	select(hhwt, inc_band, disability, cb) %>% 
	mutate(mult = cb * hhwt) %>% 
	group_by(inc_band, disability) %>% 
	summarise(avg_cost_ratio = sum(mult) / sum(hhwt)) %>% 
	ungroup() %>% 
	mutate(name = "Connecticut")
```

Read this chart as: "Households with an occupant with a disability in the Very Low cost band spend, on average, 66% of household income on housing costs." 

So the average cost ratio for households with an occupant with a disability is slightly lower than households without a disabled occupant, but the general trends in cost ratio across the cost bands still hold.

```{r}
ct_cost_ratio_inc_band_disability %>% 
	ggplot(aes(inc_band, avg_cost_ratio, group = disability)) +
	geom_col(aes(fill = disability), width = .8, position = position_dodge(.85)) +
	geom_text(aes(label = percent(avg_cost_ratio, accuracy = 1)), position = position_dodge(.85), family = "Roboto Condensed", hjust = .5, vjust = 1.2) +
	scale_fill_manual(values = c(pal[1], pal [5])) +
	guides(fill = guide_legend(title = "Household has occupant with disability")) +
	labs(title = "Average cost ratio for households in each income band",
			 subtitle = "Connecticut",
			 x = "", y = "",
			 caption = "Cost ratio is the amount of household income spent on housing costs.") +
	theme(plot.title.position = "plot", 
				legend.position = "bottom",
				panel.grid.minor = element_blank(),
				panel.grid.major = element_blank(),
				axis.text.y = element_blank(),
				axis.text.x = element_text(colour = "black"))
```


### Jobs held by household occupants

Retrieved a list of 2018 occ codes from the Census Bureau at
<https://www.census.gov/topics/employment/industry-occupation/guidance/code-lists.html>. 

This table lists the top five occupations, in order from the most numerous, for household inhabitants—so not just heads of household, but all household members, including inhabitants with no work experience in the past 5 years or who have never worked—by household income band by county.

To be honest, this is a little surprising in places. I expected more service industry workers in FC and NHC, and I'm surprised at how many elementary and middle school teachers are workers in higher income households. Either I have the exact wrong impression of how much teachers are paid or it's a common occupation for people whose partners/spouses pull in big money. And yet, #thestruggle: adjuncts and GAs in Tolland County (UConn) getting those minimum wage grad school stipends while profs in Middlesex Counties make six figures teaching half the load.

**Mark brought up a good point about common occupations (like teachers, cashiers) present in each income band. If this is used in the report, it might be best to just look at the output table and cherry pick some representative occupations.**

**An alternative approach, similar to I think what was used in the DC report, is to look at like QWI data to determine which occupations' average salaries in each county most closely align with the income band. However, that's an individual's salary versus a household's income.**

```{r jobs}
des2 <- pums %>%
	filter(hhincome != 9999999, ownershp != "N/A") %>% 
	as_survey_design(., ids = 1, wt = perwt)

occ_lut <- read_csv("../input_data/occ_codes.csv") %>% 
	mutate(occ_code = as.integer(occ_code)) #leading 0s

common_jobs_by_inc_band <- pums %>%
	select(perwt, name, inc_band, occ) %>% 
	group_by(name, inc_band, occ) %>% 
	summarise(workers = sum(perwt)) %>% 
	mutate(level = "2_counties") %>% 
	filter(occ != "0") %>% #0 is "n/a" occ
	group_by(name, inc_band) %>% 
	slice_max(workers, n = 10) %>%
	left_join(occ_lut, by = c("occ" = "occ_code")) %>% 
	select(level, name, inc_band, workers, occ, occ_label)

out$common_jobs_by_inc_band <- common_jobs_by_inc_band

common_jobs_by_inc_band %>% 
	group_by(level, name, inc_band) %>% 
	mutate(rank = order(workers, decreasing = T)) %>% 
	select(name, inc_band, rank, occ_label) %>% 
	pivot_wider(id_cols = c("name", "inc_band"), names_from = "rank", values_from = "occ_label") %>% 
	mutate(`Common occupations` = paste(`1`, `2`, `3`, `4`, `5`, sep = "; ")) %>% 
	select(Name = name, `Income band` = inc_band, `Common occupations`) %>% 
	pivot_wider(id_cols = Name, names_from = "Income band", values_from = "Common occupations") %>% 
	kable(caption = "Common occupations for workers by household income band")
```

## Cost burden by income band

```{r cb totals}
county_cb <- des %>%
	select(hhwt, name, inc_band, cost_burden) %>% 
	group_by(name, inc_band, cost_burden) %>% 
	summarise(value = survey_total(hhwt)) %>% 
	mutate(level = "2_counties")

ct_cb <- des %>%
	select(hhwt, statefip, inc_band, cost_burden) %>%
	group_by(statefip, inc_band, cost_burden) %>%
	summarise(value = survey_total(hhwt)) %>%
	mutate(name = "Connecticut", level = "1_state") %>%
	select(-statefip)

cb_by_inc_band <- bind_rows(county_cb, county_hhlds, ct_cb, ct_hhlds) %>%
	mutate(cost_burden = if_else(is.na(cost_burden), "Total", as.character(cost_burden)),
				 cost_burden = as.factor(cost_burden) %>% 
				 	fct_relevel(., "No burden", "Cost-burdened", "Severely cost-burdened", "Total")) %>% 
	ungroup() %>%
	mutate(inc_band = as.factor(inc_band) %>%
				 	fct_relevel(., "Very low", "Low", "Mid-low", "Mid-high", "High"),
				 level = as.factor(level)) %>%
	arrange(level, name, inc_band) %>%
	group_by(level, name, inc_band) %>%
	calc_shares(group = cost_burden, denom = "Total", value = value, moe = value_se)

out$cb_by_inc_band <- cb_by_inc_band
```

Real quick top level summary of cost burden before we get into the details.

```{r cb totals bar chart}
cb_by_inc_band %>% 
	ungroup() %>% 
	select(level, name, cost_burden, value) %>% 
	group_by(level, name, cost_burden) %>% 
	summarise(value = sum(value)) %>% 
	ungroup() %>% 
	group_by(level, name) %>% 
	calc_shares(group = cost_burden, denom = "Total", value = value) %>% 
	filter(!is.na(share)) %>% 
	ungroup() %>% 
	group_by(level) %>% 
	mutate(name = fct_rev(name)) %>% 
	ggplot(aes(share, name, group = cost_burden)) +
	geom_col(aes(fill = cost_burden), width = .8, position = position_stack(.5)) +
	geom_text(aes(label = percent(share, accuracy = 1)), position = position_stack(.5), family = "Roboto Condensed", size = 3.75) +
	scale_x_continuous(expand = expansion(mult = c(0, 0))) +
	scale_fill_manual(values = c("grey80", pal[1], pal[4])) +
	theme(legend.position = "bottom",
				plot.title.position = "plot", 
				axis.text.x = element_blank(),
				axis.text.y = element_text(colour = "black"),
				panel.grid.major = element_blank(),
				panel.grid.minor = element_blank()) +
	guides(fill = guide_legend(title = "", reverse = T)) +
	labs(title = "Share of households by cost burden severity",
			 x = "", y = "", caption = "Cost burdened: 30% to 49.9% household income to housing costs.\nSeverely cost burdened: 50% or more of household income to housing costs.")
```

This dot plot shows the share of cost burdened households in each income band. Statewide, almost 90% of Very Low income households pay 30%+ income to housing costs.

```{r cb rate dot plot, fig.width=8}
cb_by_inc_band %>% 
	mutate(cost_burden = fct_collapse(cost_burden, Burden = c("Cost-burdened", "Severely cost-burdened"))) %>% 
	ungroup() %>% 
	select(-share, -sharemoe, -value_se) %>% 
	group_by(level, name, inc_band, cost_burden) %>% 
	summarise(value = sum(value)) %>% 
	ungroup() %>% 
	group_by(level, name, inc_band) %>% 
	calc_shares(group = cost_burden, denom = "Total", value = value) %>% 
	filter(cost_burden == "Burden") %>% 
	group_by(level) %>% 
	mutate(name = as.factor(name) %>% 
				 	fct_rev()) %>% 
	ggplot(aes(share, name, group = inc_band)) +
	geom_point(aes(color = inc_band), size = 7.5, alpha = .8) +
	geom_text(aes(
		label = percent(share, accuracy = 1)),
		family = "Roboto Condensed", size = 3.55) +
	scale_x_continuous(expand = expansion(mult = c(.025, .1))) +
	guides(color = guide_legend(title = "")) +
	labs(
		x = "",
		y = "",
		title = "Cost-burden rates for households in each income band") +
	scale_color_custom() +
	theme(
		panel.grid.minor = element_blank(),
		panel.grid.major.x = element_blank(),
		legend.position = "bottom",
		plot.title.position = "plot",
		axis.text.x = element_blank(),
		axis.text.y = element_text(colour = "black"))
```

Above, we established 86% of Very Low income households were cost burdened, so this second dot plot breaks things down by regular and severe cost burden *(although I don't think we should do this in the report!)*.

**Note, these would add up to 100% if households with no burden were included, so the chart is read as "16% of very low income households in Connecticut are cost burdened and another 70% are severely cost burdened."**

```{r cb burden by severity dot plot, fig.height=8, fig.width=8}
cb_by_inc_band %>% 
	ungroup() %>% 
	filter(!cost_burden %in% c("Total", "No burden")) %>% 
	group_by(level) %>% 
	mutate(name = as.factor(name) %>% 
				 	fct_rev()) %>% 
	ggplot(aes(share, name, group = inc_band)) +
	geom_point(aes(color = inc_band), size = 6.5, alpha = 0.8) +
	geom_text(aes(
		label = percent(share, accuracy = 1)),
		family = "Roboto Condensed", size = 2.75, alpha = 0.8) +
	scale_x_continuous(expand = expansion(mult = c(.025, .1))) +
	facet_grid(rows = "cost_burden", scales = "free", space = "fixed") +
	guides(color = guide_legend(title = "")) +
	labs(
		x = "",
		y = "",
		title = "Rates of burden by burden type for households in each income band",
		caption = "Cost burdened: 30% to 49.9% household income to housing costs.\nSeverely cost burdened: 50% or more of household income to housing costs.") +
	scale_color_custom() +
	theme(
		panel.grid.minor = element_blank(),
		panel.grid.major.x = element_blank(),
		legend.position = "bottom",
		plot.title.position = "plot",
		axis.text.x = element_blank(),
		axis.text.y = element_text(colour = "black"))
```

Quick diversion: is the SCB rate among very low income households partially explained by some of these households having housing costs and no/negative negative income?

By definition, the household is in the "Very Low income" income band if household income is $0 or less because that's less than 30% CMI. There are about 15K Very Low income households with no or negative income and some nonzero housing cost, making them "severely cost burdened" by definition. These ~15K units make up about 7% of all very low income households, which is not insignificant, but it's not the sole motivator for high SCB rates in this income band.

```{r no income hh}
des %>%
	mutate(income = if_else(hhincome == 0, "no_income", "positive_income")) %>% 
	mutate(income = if_else(hhincome < 0, "negative_income", income)) %>% 
	select(hhwt, income, cost_burden) %>% 
	group_by(income, cost_burden) %>% 
	filter(income != "positive_income", cost_burden == "Severely cost-burdened") %>% 
	summarise(households = survey_total(hhwt))
```
## Average housing-cost-to-income ratio for each band

```{r hcost to income ratios}
avg_cost_ratio_county <- pums %>%
	filter(pernum == "1", hhincome != 9999999, ownershp != "N/A") %>%
	select(hhwt, name, inc_band, cb) %>%
	mutate(mult = cb * hhwt) %>% 
	group_by(name, inc_band) %>% 
	summarise(wm_cb = sum(mult)/sum(hhwt)) %>% 
	mutate(level = "2_counties")

avg_cost_ratio_ct <- pums %>%
	filter(pernum == "1", hhincome != 9999999, ownershp != "N/A") %>%
	select(hhwt, inc_band, cb) %>%
	mutate(mult = cb * hhwt) %>% 
	group_by(inc_band) %>% 
	summarise(wm_cb = sum(mult)/sum(hhwt)) %>% 
	mutate(name = "Connecticut", level = "1_state")

avg_cost_ratio_inc_band <- bind_rows(avg_cost_ratio_county, avg_cost_ratio_ct)

out$avg_cost_ratio_inc_band <- avg_cost_ratio_inc_band
```

Urban's DC study found that High income households paid about 12% income to housing, and used that to determine a sliding scale for affordability. In Connecticut, High income households pay about 16% income to housing costs. For a household with $200K in income, that's about $2667/month, which I just don't think is that much. For a household at the lower end of CT's High income band, earning about $114K, 16% of income to housing cost would be about $1520/month, which is just plain offensive to me as a NHV renter.

I don't think we should assume that because High income households don't pay a full 30% that the 16% threshold is what is "affordable" for them. They *can* pay more, they just *don't*. Someone earning $114K paying 16% is the same as someone earning $60K paying 30%. For the sake of fairness and communication of "affordability," I think we should do 30% for everyone.

**7/15:** Talked with the team and I think we're going to use 30% for all income bands rather than the sliding scale.

```{r hcost to income ratio dotplot}
avg_cost_ratio_inc_band %>% 
	group_by(level) %>% 
	mutate(name = as.factor(name) %>% 
				 	fct_rev()) %>% 
	mutate(wm_cb = round(wm_cb, 3)) %>% 
	ggplot(aes(wm_cb, name, group = inc_band)) +
	geom_point(aes(color = inc_band), size = 6.5, alpha = 0.8) +
	geom_vline(xintercept = .3, color = "gray60", size = 0.5, linetype = "23") +
	geom_vline(xintercept = .5, color = "gray60", size = 0.5, linetype = "23") +
	geom_text(aes(
		label = percent(wm_cb, accuracy = 1)),
		family = "Roboto Condensed", size = 2.75, alpha = 0.8) +
	scale_x_continuous(breaks = c(.3, .5),
										 labels = c("Cost burden", "Severe cost burden"),
										 expand = expansion(mult = c(.025, .1))) +
	guides(color = guide_legend(title = "")) +
	labs(
		x = "",
		y = "",
		title = str_wrap("Average housing-cost-to-income-ratio by income band", 60), caption = "A 30% ratio is cost-burden, 50% is severe cost burden") +
	scale_color_custom() +
	theme(
		panel.grid.minor = element_blank(),
		panel.grid.major.x = element_blank(),
		legend.position = "bottom",
		plot.title.position = "plot",
		axis.text.x = element_text(colour = "black"),
		axis.text.y = element_text(colour = "black"))
```

And finally... what's the average *actual* housing cost for each band? How much are households really paying?

The major takeaway is that Very Low and Low income households are paying too much. Everyone else is right on target. **See table below for affordable cost ranges.**

```{r actual costs}
cost_county_owners <- pums %>%
	filter(pernum == "1", hhincome != 9999999, ownershp == "Owned or being bought (loan)") %>%
	select(hhwt, name, inc_band, hcost = owncost)

cost_county_renters <- pums %>%
	filter(pernum == "1", hhincome != 9999999, ownershp == "Rented") %>%
	select(hhwt, name, inc_band, hcost = rentgrs)

cost_ct_owners <- pums %>%
  filter(pernum == "1", hhincome != 9999999, ownershp == "Owned or being bought (loan)") %>%
	mutate(name = "Connecticut") %>% 
	select(hhwt, name, inc_band, hcost = owncost)

cost_ct_renters <- pums %>%
	filter(pernum == "1", hhincome != 9999999, ownershp == "Rented") %>%
	mutate(name = "Connecticut") %>% 
	select(hhwt, name, inc_band, hcost = rentgrs)

avg_cost_inc_band <- bind_rows(cost_county_owners, cost_county_renters, cost_ct_owners, cost_ct_renters) %>% 
	mutate(mult = hcost * hhwt) %>% 
	group_by(name, inc_band) %>% 
	summarise(wm_cost = sum(mult)/sum(hhwt)) %>% 
	mutate(level = if_else(name == "Connecticut", "1_state", "2_counties"))

out$avg_cost_inc_band <- avg_cost_inc_band
```

```{r actual cost dot plot, fig.height=5}
avg_cost_inc_band %>% 
	group_by(level) %>% 
	mutate(name = as.factor(name) %>% 
				 	fct_rev()) %>% 
	mutate(wm_cost = round(wm_cost/1000, 1)) %>% 
	ggplot(aes(wm_cost, name, group = inc_band)) +
	geom_point(aes(color = inc_band), size = 6.5, alpha = 0.8) +
	geom_text(aes(
		label = dollar(wm_cost, accuracy = .1)),
		family = "Roboto Condensed", size = 3, alpha = 0.8) +
	scale_x_continuous(expand = expansion(mult = c(.025, .025))) +
	guides(color = guide_legend(title = "")) +
	labs(
		x = "Monthly housing cost (thousands)",
		y = "",
		title = str_wrap("Average actual housing costs by income band", 60)) +
	scale_color_custom() +
	theme(
		panel.grid.minor = element_blank(),
		panel.grid.major.x = element_blank(),
		legend.position = "bottom",
		plot.title.position = "plot",
		axis.text.x = element_blank(),
		axis.text.y = element_text(colour = "black"))
```

```{r affordability gap}
housing_cost_gap <- pums %>%
	filter(cost_burden != "No burden") %>% 
	mutate(affordable_hcost = hhincome / 12 * .3) %>% 
	mutate(affordable_cost = if_else(affordable_hcost < 0, 0, affordable_hcost)) %>% 
	mutate(actual_hcost = if_else(ownershp == "Rented", rentgrs, NULL)) %>% 
	mutate(actual_hcost = if_else(ownershp == "Owned or being bought (loan)", owncost, actual_hcost)) %>% 
	filter(actual_hcost != 999999) %>% 
	mutate(diff = actual_hcost - affordable_hcost) %>%  
	filter(diff != 0) %>% #excluding no income/no housing cost households
	mutate(mult = hhwt * diff,
				 name = as.factor(name)) %>% 
	select(name, inc_band, mult, hhwt) %>% 
	group_by(name, inc_band) %>% 
	summarise(monthly_affordability_gap = sum(mult)/sum(hhwt))
```

This unlabeled dot plot is a little more esoteric. I looked only at households whose housing costs exceed 30% of income, and took the weighted average of the gap between what they actually pay for housing versus what they should pay at a max affordable (30%) threshold. In other words, how many dollars per month over 30% are they paying?

Very Low (light green) and High income  (dark blue) households spend the most over the affordable threshold. The average gap for households in all income bands in FC is over $800/month while in most other counties the gap falls between $400 and $800/month. Over the course of a year, that's an extraordinary amount of money these households are not spending on other necessities, saving, or investing in other expensive things like higher ed.

```{r affordability gap dot plot}
housing_cost_gap %>% 
	mutate(name = fct_rev(name)) %>% 
	ggplot(aes(monthly_affordability_gap, name, group = name)) +
	geom_point(aes(color = inc_band), size = 2.5, alpha = .8) +
	scale_color_custom() +
	scale_x_continuous(breaks = c(400, 800, 1200),
										 expand = expansion(mult = c(.1, .1)),
										 labels = dollar_format()) +
	guides(color = guide_legend(title = "")) +
	labs(title = str_wrap("How much money per month over 30% are households paying in housing costs?", 60),
			 x = "", y = "") +
theme(plot.title.position = "plot",
			axis.text.y = element_text(colour = "black", size = 11),
			axis.text.x = element_text(colour = "black", size = 11),
			legend.position = "right")
```

## Ranges of affordability for each band

Some future iteration of this analysis should find a way to combine this table with the actual housing costs chart above, but the topline is that the average actual costs in Low and Very Low income households exceed the affordable threshold (except low income households in Windham County). The middle-to-high income households' average actual housing cost is within the affordable range.

```{r affordable cost range table}
affordable_cost_table <- minc %>% 
	bind_rows(ctminc) %>% 
	select(-countyfip) %>% 
	mutate(vl = minc * .3,
				 l = minc * .5,
				 ml = minc * .8, 
				 mh = minc * 1.2) %>% 
	select(-minc) %>% 
	pivot_longer(cols = vl:mh, names_to = "inc_band", values_to = "income") %>% 
	mutate(income = round(income, 0),
				 affordable_hcost = round(income / 12 * .3, 0)) %>% 
	select(name, inc_band, affordable_hcost) %>% 
	mutate(affordable_hcost = comma(affordable_hcost, accuracy = 1)) %>% 
	pivot_wider(id_cols = name, names_from = inc_band, values_from = affordable_hcost) %>% 
	mutate(`Very low` = paste("Less than $", vl, sep = ""),
				 Low = paste("Between $", vl, " and $", l, sep = ""),
				 `Mid-low` = paste("Between $", l, " and $", ml, sep = ""),
				 `Mid-high` = paste("Between $", ml, " and $", mh, sep = ""),
				 High = paste("More than $", mh, sep = ""))

kable(affordable_cost_table %>% 
				select(Name = name, `Very low`:High),
			caption = "Affordable monthly housing cost ranges by income band and area")
```

## What income band do households live in, what cost band do they pay in?

```{r units by cost band}
owners <- pums %>%
	filter(pernum == "1", hhincome != 9999999, ownershp == "Owned or being bought (loan)") %>%
	select(hhwt, name, minc, inc_band, hcost = owncost)

renters <- pums %>%
	filter(pernum == "1", hhincome != 9999999, ownershp == "Rented") %>%
	select(hhwt, name, minc, inc_band, hcost = rentgrs)

units <- bind_rows(owners, renters) %>% 
	mutate(cost_band = NULL) %>%
	group_by(name) %>% 
	mutate(cost_band = if_else(between(hcost, 0, (minc * .3 / 12 * .3)), "Very low", "High")) %>% 
	mutate(cost_band = if_else(between(hcost, ((minc * .3 / 12 * .3) + 1), (minc * .5 / 12 * .3)), "Low", cost_band)) %>% 
	mutate(cost_band = if_else(between(hcost, ((minc * .5 / 12 * .3) + 1), (minc * .8 / 12 * .3)), "Mid-low", cost_band)) %>% 
	mutate(cost_band = if_else(between(hcost, ((minc * .8 / 12 * .3) + 1), (minc * 1.2 / 12 * .3)), "Mid-high", cost_band))

out$all_units_inc_and_cost_bands <- units	

codes <- tibble(
	code = seq(1:5),
	band = c("Very low", "Low", "Mid-low", "Mid-high", "High"))

units_by_income <- units %>% 
	select(name, hhwt, inc_band) %>% 
	group_by(name, inc_band) %>% 
	summarise(households = sum(hhwt))

county_units_by_cost_income <- units %>% 
	select(name, hhwt, inc_band = cost_band) %>% 
	group_by(name, inc_band) %>% 
	summarise(units = sum(hhwt)) %>% 
	left_join(units_by_income, by = c("name", "inc_band")) %>% 
	pivot_longer(cols = c("households", "units"), names_to = "group")

ct_units_by_cost_income <- county_units_by_cost_income %>% 
	ungroup() %>% 
	mutate(name = "Connecticut") %>% 
	group_by(name, inc_band, group) %>% 
	summarise(value = sum(value))

units_by_cost_income <- bind_rows(county_units_by_cost_income, ct_units_by_cost_income) %>% 
	mutate(level = if_else(name == "Connecticut", "1_state", "2_counties"))
```

```{r no eval3, fig.height=9, fig.width=9, eval = F}
units_by_cost_income %>% 
	mutate(group = as.factor(group) %>% 
				 	fct_relevel(., "units", "households")) %>% 
	mutate(inc_band = as.factor(inc_band) %>% 
				 	fct_relevel(., "Very low", "Low", "Mid-low", "Mid-high", "High")) %>% 
	ggplot(aes(inc_band, value, group = group)) +
	geom_col(aes(fill = group), width = .8, position = position_dodge(.85)) +
	geom_text(aes(label = comma(value, accuracy = 1)), position = position_dodge(.85), vjust = "top", family = "Roboto Condensed", size = 3.5, fontface = "bold") +
	facet_grid(rows = vars(name), scales = "free", space = "fixed", switch = "y") +
	scale_fill_manual(values = c(pal[1], pal[3])) +
	guides(fill = guide_legend(title = "")) +
	theme(legend.position = "bottom",
				plot.title.position = "plot",
				panel.grid.minor = element_blank(),
				panel.grid.major = element_blank(),
				axis.text.y = element_blank(),
				axis.text.x = element_text(colour = "black", size = 11),
				strip.text.y.left = element_text(color = "black", size = 8, angle = 360)) +
	labs(title = "Counts of households and units by band",
			 x = "", y = "", caption = "Does not include vacant units")
```

There are many more higher income households than units in that cost band, so high income households have to occupy housing affordable to lower-income households. Likewise, the same holds at the other extreme: there are many more very low income households than very low income units and they have to occupy more expensive housing than they can afford.

Knowing that households paying into a cost band are a subset of households across many income bands, here's a heat map of households by income band and the cost band they pay into. Add each row and you'll get the total number of households in each income band. Add each column and you'll get the total of all households in each cost band.

There are a couple caveats... people who own their homes outright and just have some utility costs are usually in the Very Low cost band but may be in any income band. There are also a fair amount of people who are high income but have $0 cash rents (I guess their company owns their apartments and they live rent free?) who would be in the Very Low cost band.

```{r no eval4, eval = F}
relative_housing_costs <- units %>%
	ungroup() %>%
	left_join(codes, by = c("inc_band" = "band")) %>%
	rename(inc_code = code) %>%
	left_join(codes, by = c("cost_band" = "band")) %>%
	rename(cost_code = code) %>%
	mutate(cost_paid = if_else(inc_code == cost_code, "same", "higher")) %>%
	mutate(cost_paid = if_else(inc_code > cost_code, "lower", cost_paid)) %>%
	select(hhwt, name, inc_band, cost_paid) %>%
	mutate(inc_band = as.factor(inc_band) %>% 
				 	fct_relevel(., "Very low", "Low", "Mid-low", "Mid-high", "High")) %>% 
	group_by(name, inc_band, cost_paid) %>%
	summarise(value = sum(hhwt))

ct_hhld_totals <- ct_hhlds %>% 
	mutate(cost_paid = "total") %>% 
	select(inc_band, cost_paid, value)

ct_relative <- relative_housing_costs %>% 
	select(-name) %>% 
	group_by(inc_band, cost_paid) %>% 
	summarise(value = sum(value)) %>%
	bind_rows(ct_hhld_totals) %>% 
	ungroup() %>%
	group_by(inc_band) %>% 
	calc_shares(group = cost_paid, denom = "total", value = value)

ct_relative %>% 
	filter(cost_paid != "total") %>% 
	mutate(cost_paid = as.factor(cost_paid) %>% 
				 	fct_rev()) %>% 
	mutate(inc_band = as.factor(inc_band) %>% 
				 	fct_rev()) %>% 
	ggplot(aes(share, inc_band)) +
	geom_col(aes(fill = cost_paid), width = .75, position = position_stack()) +
	geom_text(aes(label = percent(share, accuracy = 1)), position = position_stack(.5), family = "Roboto Condensed") +
	scale_x_continuous(expand = expansion(mult = c(0, 0))) +
	scale_fill_custom() +
	labs(title = str_wrap("Share of households paying into the same, lower, or higher cost bands than their income band", 60), subtitle = "Connecticut", x = "", y = "") +
	theme(plot.title.position = "plot",
				axis.text.y = element_text(colour = "black"),
				axis.text.x = element_blank(),
				panel.grid.major = element_blank(),
				panel.grid.minor = element_blank())
```

```{r income vs cost band heat map, fig.width=6, fig.height=6}
income_vs_cost_bands <- units %>%
	select(-minc, -hcost, -name) %>%
	group_by(inc_band, cost_band) %>%
	summarise(units = sum(hhwt)) %>%
	mutate(inc_band = as.factor(inc_band) %>%
				 	fct_relevel(., "Very low", "Low", "Mid-low", "Mid-high", "High")) %>%
	mutate(cost_band = as.factor(cost_band) %>%
				 	fct_relevel(., "Very low", "Low", "Mid-low", "Mid-high", "High"))

income_vs_cost_bands %>% 
	mutate(inc_band = fct_rev(inc_band)) %>% 
	ggplot(aes(cost_band, inc_band, fill = units)) +
	geom_tile(show.legend = F) +
	geom_text(aes(label = comma(units)), family = "Roboto Condensed") +
	scale_x_discrete(position = "top",
									 expand = expansion(mult = c(0,0))) +
	scale_y_discrete(expand = expansion(mult = c(0,0))) +
	scale_fill_gradient(low = pal[3], high = pal[5]) +
	labs(title = "Households by income and cost bands",
			 subtitle = "Connecticut",
			 y = "Count of households in this income band...\n",
			 x = "... whose housing unit is in this cost band.\n") +
	theme(plot.title.position = "plot",
				axis.text.x = element_text(colour = "black"),
				axis.text.y = element_text(colour = "black"),
				axis.title.y = element_text(angle = 90, hjust = 0))
```

## How many housing units are in each cost bands

Further establishing that there's a need for housing in lower cost bands, how many units exist in each band? This adds vacants to the occupied units above.

Vacant apartments and homes for sale have imputed costs based on contract rent plus imputed utilities (see below), and homes for sale had owner-costs imputed based on county average mortgage rates (2019 HMDA data for approved first lien mortgages for homes intended for owner occupancy), the median mill rate for each county, and imputed utility costs.

I used a ratio of RENTGRS to RENT to determine how much utilities run on top of contract rent (by county). I can't think of a similar way to do that for homes for sale so I used the same ratio for owner units, too.

```{r hh level pums setup}
hddi <- read_ipums_ddi("../input_data/usa_00040.xml")

cost_bands <- minc %>% 
	bind_rows(ctminc) %>% 
	select(-countyfip) %>% 
	mutate(vl = round((minc * .3 / 12 * .3), 0),
				 l = round((minc * .5 / 12 * .3), 0),
				 ml = round((minc * .8 / 12 * .3), 0), 
				 mh = round((minc * 1.2 / 12 * .3), 0)) %>% 
	select(-minc)

hpums <- read_ipums_micro(hddi, verbose = F) %>% 
	filter(RECTYPE == "H") %>% 
	mutate_at(vars(OWNERSHP, OWNERSHPD, VACANCY), as_factor) %>% 
	mutate_at(vars(OWNCOST, RENT, RENTGRS, VALUEH), as.numeric) %>% 
	janitor::clean_names() %>% 
	left_join(minc, by = "countyfip") %>% 
	left_join(cost_bands, by = "name") %>% 
	mutate(countyfip = as.character(countyfip))
```

```{r occ units by cost band}
occ_des <- hpums %>%
	filter(vacancy == "N/A", ownershp != "N/A") %>% 
	as_survey_design(., ids = 1, wt = hhwt)

own_occ_cost_bands <- occ_des %>%
	filter(owncost != 99999) %>% 
	select(hhwt, name, owncost, vl, l, ml, mh) %>% 
	group_by(name) %>% 
	mutate(tenure = "owner",
				 occupancy = "occupied",
				 very_low = between(owncost, 0, (vl - 1)),
				 low = between(owncost, vl, (l - 1)),
				 mid_low = between(owncost, l, (ml - 1)),
				 mid_high = between(owncost, ml, (mh - 1)),
				 high = between(owncost, mh, Inf)) %>% 
	ungroup() %>% 
	group_by(name, tenure, occupancy, very_low, low, mid_low, mid_high, high) %>% 
	summarise(units = survey_total(hhwt)) %>% 
	pivot_longer(cols = very_low:high, names_to = "cost_band") %>% 
	filter(value == T) %>% 
	select(name, tenure, occupancy, cost_band, units)

rent_occ_cost_bands <- occ_des %>%
	filter(owncost == 99999) %>% 
	select(hhwt, name, rentgrs, vl, l, ml, mh) %>% 
	group_by(name) %>% 
	mutate(tenure = "renter",
				 occupancy = "occupied",
				 very_low = between(rentgrs, 0, (vl - 1)),
				 low = between(rentgrs, vl, (l - 1)),
				 mid_low = between(rentgrs, l, (ml - 1)),
				 mid_high = between(rentgrs, ml, (mh - 1)),
				 high = between(rentgrs, mh, Inf)) %>% 
	ungroup() %>% 
	group_by(name, tenure, occupancy, very_low, low, mid_low, mid_high, high) %>% 
	summarise(units = survey_total(hhwt)) %>% 
	pivot_longer(cols = very_low:high, names_to = "cost_band") %>% 
	filter(value == T) %>% 
	select(name, tenure, occupancy, cost_band, units)

occ_cost_bands <- bind_rows(own_occ_cost_bands, rent_occ_cost_bands)
```

```{r rent vac on mkt}
utility_pmts <- hpums %>% 
	filter(rent != 0 & rentgrs != 0) %>% 
	mutate(ratio = rentgrs / rent) %>% 
	mutate(mult = ratio * hhwt) %>% 
	select(countyfip, mult, hhwt) %>% 
	group_by(countyfip) %>% 
	summarise(avg_ratio = sum(mult) / sum(hhwt))

rent_vac <- hpums %>%
	left_join(utility_pmts, by = "countyfip") %>% 
	filter(owncost == "99999", vacancy == "For rent or sale") %>% 
	select(hhwt, name, rent, avg_ratio, vl, l, ml, mh) %>% 
	mutate(imputed_rentgrs = avg_ratio * rent) %>% 
	group_by(name) %>% 
	mutate(tenure = "renter",
				 occupancy = "vacant-on market",
				 very_low = between(imputed_rentgrs, 0, (vl - 1)),
				 low = between(imputed_rentgrs, vl, (l - 1)),
				 mid_low = between(imputed_rentgrs, l, (ml - 1)),
				 mid_high = between(imputed_rentgrs, ml, (mh - 1)),
				 high = between(imputed_rentgrs, mh, Inf)) %>% 
	ungroup() %>% 
	group_by(name, tenure, occupancy, very_low, low, mid_low, mid_high, high) %>% 
	summarise(units = sum(hhwt)) %>% 
	pivot_longer(cols = very_low:high, names_to = "cost_band") %>% 
	filter(value == T) %>% 
	select(name, tenure, occupancy, cost_band, units)
```

```{r own vac on mkt}
avg_int_rates <- read_csv("../input_data/hmda_2019_lar.csv") %>% 
	select(countyfip = county_code, interest_rate) %>% 
	filter(!is.na(interest_rate), interest_rate != "Exempt", !is.na(countyfip)) %>%
	mutate(interest_rate = as.numeric(interest_rate), 
				countyfip = str_remove(countyfip, "090"),
				 countyfip = str_remove(countyfip, "^0+")) %>% 
	group_by(countyfip) %>% 
	summarise(avg_int_rate = round(mean(interest_rate) / 100, 4)) %>% 
	mutate(countyfip = as.character(countyfip))

median_mills <- read_csv("../input_data/mill_rates_2019.csv") %>% 
	left_join(town2county, by = c("name" = "town")) %>% 
	select(-name) %>% 
	left_join(minc, by = c("county" = "name")) %>% 
	select(countyfip, county, mill_rate) %>%
	group_by(countyfip, county) %>% 
	summarise(median_mill = median(mill_rate)) %>% 
  mutate(countyfip = as.character(countyfip))

pmi <- .007 #avg private mortgage insurance rate ~0.7%

#impute remaining utility costs
own_vac <- hpums %>%
	left_join(utility_pmts, by = "countyfip") %>% 
	left_join(avg_int_rates, by = "countyfip") %>% 
	left_join(median_mills, by = "countyfip") %>% 
	filter(vacancy == "For sale only") %>% 
	mutate(loan = .9 * valueh, # 10% down
				 monthly_int = (avg_int_rate / 12), #annual rate divided across a year
				 monthly_pmt = loan * monthly_int * ((1+monthly_int)**360)/(((1+monthly_int)**360)-1), #principal and interest
				 mortgage_ins = pmi * loan / 12, #mortgage insurance at .7%
				 property_tax = valueh / 1000 * median_mill / 12,
				 total_monthly_pmt = monthly_pmt + mortgage_ins + property_tax,
				 imputed_owncost = total_monthly_pmt * avg_ratio) %>% 
	select(hhwt, name, imputed_owncost, vl, l, ml, mh) %>% 
	group_by(name) %>% 
	mutate(tenure = "owner",
				 occupancy = "vacant-on market",
				 very_low = between(imputed_owncost, 0, (vl - 1)),
				 low = between(imputed_owncost, vl, (l - 1)),
				 mid_low = between(imputed_owncost, l, (ml - 1)),
				 mid_high = between(imputed_owncost, ml, (mh - 1)),
				 high = between(imputed_owncost, mh, Inf)) %>% 
	ungroup() %>% 
	group_by(name, tenure, occupancy, very_low, low, mid_low, mid_high, high) %>% 
	summarise(units = sum(hhwt)) %>% 
	pivot_longer(cols = very_low:high, names_to = "cost_band") %>% 
	filter(value == T) %>% 
	select(name, tenure, occupancy, cost_band, units)
```

```{r off mkt vacs}
other_vac_rent <- hpums %>% 
	filter(vacancy == "Rented or sold but not (yet) occupied") %>%
	filter(valueh == "9999999") %>% 
	left_join(utility_pmts, by = "countyfip") %>% 
	select(hhwt, name, rent, avg_ratio, vl, l, ml, mh) %>% 
	mutate(imputed_rentgrs = avg_ratio * rent) %>% 
	group_by(name) %>% 
	mutate(tenure = "renter",
				 occupancy = "vacant-off market",
				 very_low = between(imputed_rentgrs, 0, (vl - 1)),
				 low = between(imputed_rentgrs, vl, (l - 1)),
				 mid_low = between(imputed_rentgrs, l, (ml - 1)),
				 mid_high = between(imputed_rentgrs, ml, (mh - 1)),
				 high = between(imputed_rentgrs, mh, Inf)) %>% 
	ungroup() %>% 
	group_by(name, tenure, occupancy, very_low, low, mid_low, mid_high, high) %>% 
	summarise(units = sum(hhwt)) %>% 
	pivot_longer(cols = very_low:high, names_to = "cost_band") %>% 
	filter(value == T) %>% 
	select(name, tenure, occupancy, cost_band, units)

other_vac_own <- hpums %>%
	left_join(utility_pmts, by = "countyfip") %>% 
	left_join(avg_int_rates, by = "countyfip") %>% 
	left_join(median_mills, by = "countyfip") %>% 
  filter(vacancy == "Rented or sold but not (yet) occupied") %>%
	filter(valueh != "9999999") %>% 
	mutate(loan = .9 * valueh, # 10% down
				 monthly_int = (avg_int_rate / 12), #annual rate divided across a year
				 monthly_pmt = loan * monthly_int * ((1+monthly_int)**360)/(((1+monthly_int)**360)-1), #principal and interest
				 mortgage_ins = pmi * loan / 12, #mortgage insurance at .7%
				 property_tax = valueh / 1000 * median_mill / 12,
				 total_monthly_pmt = monthly_pmt + mortgage_ins + property_tax,
				 imputed_owncost = total_monthly_pmt * avg_ratio) %>% 
	select(hhwt, name, imputed_owncost, vl, l, ml, mh) %>% 
	group_by(name) %>% 
	mutate(tenure = "owner",
				 occupancy = "vacant-off market",
				 very_low = between(imputed_owncost, 0, (vl - 1)),
				 low = between(imputed_owncost, vl, (l - 1)),
				 mid_low = between(imputed_owncost, l, (ml - 1)),
				 mid_high = between(imputed_owncost, ml, (mh - 1)),
				 high = between(imputed_owncost, mh, Inf)) %>% 
	ungroup() %>% 
	group_by(name, tenure, occupancy, very_low, low, mid_low, mid_high, high) %>% 
	summarise(units = sum(hhwt)) %>% 
	pivot_longer(cols = very_low:high, names_to = "cost_band") %>% 
	filter(value == T) %>% 
	select(name, tenure, occupancy, cost_band, units)
```

```{r bind all units}
vac_cost_bands <- bind_rows(rent_vac, own_vac, other_vac_own, other_vac_rent)

units_by_tenure_occupancy_cost_band <- bind_rows(occ_cost_bands, vac_cost_bands) %>% 
	mutate(cost_band = str_to_sentence(cost_band),
				 cost_band = str_replace(cost_band, "_", "-"),
				 cost_band = if_else(cost_band == "Very-low", "Very low", cost_band)) %>% 
	mutate(cost_band = as.factor(cost_band) %>% 
				 	fct_relevel(., "Very low", "Low", "Mid-low", "Mid-high", "High")) %>% 
	mutate(occupancy = as.factor(occupancy) %>% 
				 	fct_relevel(., "occupied", "vacant"))

out$units_by_tenure_occupancy_cost_band <- units_by_tenure_occupancy_cost_band

```

In addition to the occupied units we've already looked at, this chart adds two categories of vacant units: "Vacant-On market" units are listed as "For rent or sale" or "For sale only," and "Vacant-Off market" are vacant units that have been sold or rented but are not yet occupied.

```{r units by tenure and occ bar chart}
units_by_tenure_occupancy_cost_band %>% 
	mutate(occupancy = str_to_sentence(occupancy)) %>% 
	select(-tenure, -name) %>% 
	arrange(cost_band) %>% 
	group_by(occupancy, cost_band) %>% 
	summarise(units = sum(units)) %>% 
	ggplot(aes(cost_band, units, group = cost_band)) +
	geom_col(aes(fill = occupancy), width = .75) +
	ggrepel::geom_text_repel(aes(label = comma(units)), family = "Roboto Condensed", size = 3.5, position = position_stack(.5)) +
	scale_y_continuous(labels = comma_format(),
										 expand = expansion(mult = c(0, .1)),
										 breaks = c(1e5, 2e5, 3e5, 4e5)) +
	scale_fill_manual(values = c(pal[1], pal[5], pal[3])) +
	guides(fill = guide_legend(title = "")) + 
	theme(plot.title.position = "plot",
				panel.grid.minor = element_blank(),
				panel.grid.major.x = element_blank(),
				axis.text.x = element_text(colour = "black"),
				axis.text.y = element_text(colour = "black"),
				legend.position = "bottom") +
	labs(title = "Total housing units in each cost band",
			 subtitle = "Connecticut",
			 x = "", y = "")
```

There are two other major vacancy categories, "Other vacant" and "For seasonal, recreational, or other occasional use," but there's no cost information associated with those units, so they can't be sorted into the appropriate cost bands. Another minor category are housing units reserved for migrant farm workers. Collectively, these comprise about 83,000 units, which is a ton by CT standards. The cities of Bridgeport, New Haven, and Hartford all have about 50,000 units each.

```{r other vacs}
hpums %>% 
	filter(vacancy %in% c("For seasonal, recreational or other occasional use", "For migrant farm workers", "Other vacant")) %>%
	select(vacancy, hhwt) %>% 
	group_by(vacancy) %>% 
	summarise(hhwt = sum(hhwt))
```

## Households who need housing in each cost band

This bar chart is the major summary of this analysis. It shows occupied units in each income band versus units available in their cost band. In essence, the households in each income band need a unit in their cost band.

The data show significant gaps in the extremes... Very Low and High income households do not have enough units in their affordability range (though with High income households I think we care less about whether they have enough high cost units and more that they aren't squeezing the middle out of a place to live).

While there are a lot of middle income units, competition for those units is coming from above and below. More housing units in the Very Low range are absolutely needed. Since High income households tend to want to pay less than 30% for housing, more (well-located and not just single family) mid-high units could help alleviate some strain on the middle income households.

```{r units vs hh}
all_units_by_inc_band <- units_by_tenure_occupancy_cost_band %>% 
  select(-tenure, -occupancy) %>% 
	group_by(name, cost_band) %>% 
	summarise(units = sum(units)) %>% 
	bind_rows(units_by_tenure_occupancy_cost_band %>% 
							select(-tenure, -occupancy) %>% 
							mutate(name = "Connecticut") %>% 
							group_by(name, cost_band) %>% 
							summarise(units = sum(units))) %>% 
	rename(band = cost_band)

units_and_hh <- hh_by_inc_band %>% 
	ungroup() %>% 
	select(name, band = inc_band, households = value) %>% 
	filter(band != "Total") %>% 
	left_join(all_units_by_inc_band, by = c("name", "band")) %>%
	pivot_longer(cols = c("households", "units"), names_to = "group")
```

```{r units v hh bar chart, fig.height=9, fig.width=9}
units_and_hh %>% 
	ggplot(aes(band, value, group = group)) +
	geom_col(aes(fill = group), position = position_dodge()) +
	scale_y_continuous(labels = comma_format()) +
	facet_wrap(facets = "name", scales = "free_y") +
	scale_fill_manual(values = c(pal[1], pal[3])) +
	labs(title = "Households and housing units in each band",
			 x = "", y = "", caption = "Units include vacant units") +
	guides(fill = guide_legend(title = "")) +
	theme(plot.title.position = "plot",
				axis.text.y = element_text(colour = "black"),
				panel.grid.major.x = element_blank(),
				panel.grid.minor = element_blank(),
				legend.position = "bottom",
				axis.text.x = element_text(colour = "black", angle = -60, hjust = 0, vjust = .5))
```

## Add homeless households?
Mark suggests https://cceh.org for subcounty estimates, but I'm not sure how best to align CANs to counties, so instead I think this should be separate and included in the statewide count.

Looks like in 2018 there were 2,253 adults-only households, 370 adults-and-children households, and 7 children-only households for a total of 2,630 households (3,383 people). We should add these households to very low income units needed.

Source: https://cceh.org/data/interactive/2018pitdashboard/